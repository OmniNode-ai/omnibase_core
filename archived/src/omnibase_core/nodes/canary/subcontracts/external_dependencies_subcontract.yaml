# External Dependencies Subcontract - EFFECT Node External Service Integration
# Provides standardized external service integrations, API calls, and I/O operations for EFFECT nodes only

contract_type: "external_dependencies_subcontract"
contract_version:
  major: 1
  minor: 0
  patch: 0

metadata:
  name: "ExternalDependenciesSubcontract"
  description: "External service integrations, API calls, and I/O operations for EFFECT nodes"
  author: "ONEX Framework Team"
  created: "2025-09-01"
  purpose: "Define comprehensive external service integration patterns with circuit breaker, fallback strategies, and health monitoring"
  applicable_node_types: ["EFFECT"] # EFFECT only - architectural constraint

business_logic:
  pattern: "external_service_integration"
  ai_agent:
    capabilities: ["external_api_calls", "circuit_breaker_management", "fallback_strategies", "health_monitoring"]
    coordination_patterns: ["service_mesh_integration", "distributed_tracing", "error_recovery"]
    performance_targets:
      api_call_latency: "<30s"
      health_check_frequency: "30s"
      circuit_breaker_recovery: "<60s"

# === EXTERNAL DEPENDENCY ACTIONS ===
actions:
  execute_external_call:
    description: "Execute call to external service or API"
    operation_type: "external_service_invocation"
    inputs:
      service_config:
        type: "object"
        description: "Configuration for external service connection"
        properties:
          endpoint: "string"
          timeout_ms: "integer"
          authentication: "object"
      call_parameters:
        type: "object"
        description: "Parameters for the external service call"
      retry_config:
        type: "object"
        description: "Retry policy configuration"
        properties:
          max_retries: "integer"
          initial_delay_ms: "integer"
          exponential_backoff: "boolean"
    outputs:
      call_result:
        type: "ModelCallResult"
        description: "Result of external service call execution"
      execution_metadata:
        type: "ModelExecutionMetadata"
        description: "Metadata about external service call execution"
    required: true
    timeout_ms: 30000

  validate_external_response:
    description: "Validate response from external service"
    operation_type: "response_validation"
    inputs:
      response_data:
        type: "object"
        description: "Response data from external service"
      validation_schema:
        type: "object"
        description: "Schema for validating response"
      service_contract:
        type: "object"
        description: "Service contract specifications"
    outputs:
      validation_result:
        type: "ModelValidationResult"
        description: "Result of external service response validation"
      normalized_response:
        type: "object"
        description: "Response data normalized to internal format"
    required: true
    timeout_ms: 2000

  manage_service_health:
    description: "Monitor and manage health of external dependencies"
    operation_type: "health_monitoring"
    inputs:
      service_list:
        type: "array"
        description: "List of services to monitor"
        items: "string"
      health_check_config:
        type: "object"
        description: "Health check configuration"
    outputs:
      health_status:
        type: "ModelHealthStatus"
        description: "Health status of an external service"
      availability_metrics:
        type: "object"
        description: "Service availability metrics"
    required: false
    timeout_ms: 10000

  handle_service_failure:
    description: "Handle failures from external services with fallback strategies"
    operation_type: "failure_handling"
    inputs:
      failure_context:
        type: "object"
        description: "Context information about the failure"
      fallback_config:
        type: "object"
        description: "Fallback strategy configuration"
      recovery_options:
        type: "object"
        description: "Available recovery options"
    outputs:
      recovery_action:
        type: "string"
        description: "Action taken for recovery"
      fallback_result:
        type: "ModelFallbackResult"
        description: "Result of fallback strategy execution"
    required: true
    timeout_ms: 5000

  transform_external_data:
    description: "Transform data between internal and external formats"
    operation_type: "data_transformation"
    inputs:
      source_data:
        type: "object"
        description: "Source data to transform"
      transformation_config:
        type: "object"
        description: "Transformation configuration"
      target_schema:
        type: "object"
        description: "Target schema for transformation"
    outputs:
      transformed_data:
        type: "object"
        description: "Data transformed to target format"
      transformation_metadata:
        type: "ModelTransformationMetadata"
        description: "Metadata about data transformation operations"
    required: false
    timeout_ms: 3000

# === EXTERNAL DEPENDENCY CONFIGURATION ===
external_dependency_config:
  connection_pool_size: 20
  default_timeout_ms: 15000
  max_concurrent_calls: 50
  circuit_breaker_enabled: true
  retry_policy:
    max_retries: 3
    initial_delay_ms: 1000
    max_delay_ms: 10000
    exponential_backoff: true
    jitter_enabled: true
  rate_limiting:
    enabled: true
    requests_per_second: 100
    burst_capacity: 200

# === SERVICE TYPES ===
supported_service_types:
  rest_api:
    protocol: "HTTP/HTTPS"
    authentication: ["bearer_token", "api_key", "oauth2", "basic_auth"]
    serialization: ["json", "xml", "form_data"]
    compression: ["gzip", "deflate"]
  database:
    protocols: ["postgresql", "mysql", "mongodb", "cassandra"]
    connection_pooling: true
    transaction_support: true
    streaming_support: false
  message_queue:
    protocols: ["kafka", "rabbitmq", "aws_sqs", "azure_service_bus"]
    delivery_guarantee: ["at_least_once", "at_most_once", "exactly_once"]
    batching_support: true
  file_storage:
    protocols: ["s3", "azure_blob", "gcs", "sftp", "local"]
    streaming_support: true
    encryption_support: true
    versioning_support: true
  external_apis:
    protocols: ["rest", "graphql", "grpc", "soap"]
    authentication_flows: ["oauth2", "api_key", "jwt", "custom"]
    rate_limiting_aware: true

# === CIRCUIT BREAKER PATTERNS ===
circuit_breaker_config:
  failure_threshold: 10
  timeout_duration_ms: 60000 # 1 minute
  half_open_max_calls: 3
  metrics_window_ms: 10000 # 10 seconds
  min_calls_for_evaluation: 5

# === FALLBACK STRATEGIES ===
fallback_strategies:
  cached_response:
    enabled: true
    cache_ttl_ms: 300000 # 5 minutes
    stale_while_revalidate: true
  default_response:
    enabled: true
    response_templates: {}
    static_fallbacks: {}
  alternative_service:
    enabled: false
    service_priority_list: []
    automatic_failover: true
  graceful_degradation:
    enabled: true
    reduced_functionality_mode: true
    user_notification_required: true

# === OUTPUT MODELS ===
output_models:
  ModelCallResult:
    description: "Result of external service call execution"
    fields:
      success:
        type: "boolean"
        description: "Whether the external call was successful"
        required: true
      response_data:
        type: "object"
        description: "Response data from external service"
        default: {}
      http_status:
        type: "integer"
        description: "HTTP status code from external service"
        validation: "ge=100,le=599"
        required: true
      response_time_ms:
        type: "integer"
        description: "Response time in milliseconds"
        validation: "ge=0"
        required: true
      service_endpoint:
        type: "string"
        description: "External service endpoint that was called"
        required: true
      headers:
        type: "object"
        description: "Response headers from external service"
        additionalProperties: "string"
        default: {}
      retry_count:
        type: "integer"
        description: "Number of retries attempted"
        validation: "ge=0"
        default: 0
      circuit_breaker_state:
        type: "enum[CLOSED,OPEN,HALF_OPEN]"
        description: "Current circuit breaker state"
        default: "CLOSED"

  ModelExecutionMetadata:
    description: "Metadata about external service call execution"
    fields:
      service_name:
        type: "string"
        description: "Name of the external service"
        required: true
      operation_name:
        type: "string"
        description: "Name of the operation performed"
        required: true
      start_time:
        type: "datetime"
        description: "When the operation started"
        required: true
      end_time:
        type: "datetime"
        description: "When the operation completed"
        required: true
      total_time_ms:
        type: "integer"
        description: "Total execution time in milliseconds"
        validation: "ge=0"
        required: true
      network_time_ms:
        type: "integer"
        description: "Network time in milliseconds"
        validation: "ge=0"
        required: true
      processing_time_ms:
        type: "integer"
        description: "Processing time in milliseconds"
        validation: "ge=0"
        required: true
      bytes_sent:
        type: "integer"
        description: "Number of bytes sent"
        validation: "ge=0"
        default: 0
      bytes_received:
        type: "integer"
        description: "Number of bytes received"
        validation: "ge=0"
        default: 0

  ModelHealthStatus:
    description: "Health status of an external service"
    fields:
      service_name:
        type: "string"
        description: "Name of the external service"
        required: true
      status:
        type: "enum[HEALTHY,DEGRADED,UNHEALTHY,UNKNOWN]"
        description: "Current health status of the service"
        required: true
      last_check:
        type: "datetime"
        description: "When the health check was last performed"
        required: true
      response_time_ms:
        type: "integer"
        description: "Response time of last health check in milliseconds"
        validation: "ge=0"
        required: true
      error_rate_percent:
        type: "float"
        description: "Error rate percentage over recent window"
        validation: "ge=0.0,le=100.0"
        required: true
      availability_percent:
        type: "float"
        description: "Availability percentage over recent window"
        validation: "ge=0.0,le=100.0"
        required: true
      circuit_breaker_state:
        type: "string"
        description: "Current circuit breaker state"
        required: true

  ModelFallbackResult:
    description: "Result of fallback strategy execution"
    fields:
      fallback_strategy_used:
        type: "string"
        description: "Name of the fallback strategy that was used"
        required: true
      fallback_success:
        type: "boolean"
        description: "Whether the fallback strategy was successful"
        required: true
      fallback_data:
        type: "object"
        description: "Data returned by the fallback strategy"
        default: {}
      original_error:
        type: "string"
        description: "Original error that triggered the fallback"
        required: true
      degradation_level:
        type: "enum[NONE,PARTIAL,FULL]"
        description: "Level of service degradation applied"
        required: true

  ModelValidationResult:
    description: "Result of external service response validation"
    fields:
      validation_success:
        type: "boolean"
        description: "Whether validation was successful"
        required: true
      validation_errors:
        type: "array"
        description: "List of validation errors if any"
        items: "string"
        default: []
      normalized_response:
        type: "object"
        description: "Response data normalized to internal format"
        default: {}

  ModelTransformationMetadata:
    description: "Metadata about data transformation operations"
    fields:
      source_format:
        type: "string"
        description: "Source data format"
        required: true
      target_format:
        type: "string"
        description: "Target data format"
        required: true
      transformation_type:
        type: "string"
        description: "Type of transformation performed"
        required: true
      transformation_time_ms:
        type: "integer"
        description: "Time taken for transformation in milliseconds"
        validation: "ge=0"
        required: true
      records_processed:
        type: "integer"
        description: "Number of records processed"
        validation: "ge=0"
        default: 0

# === DEPENDENCIES PROVIDED ===
dependencies:
  - name: "external_integration"
    type: "capability"
    description: "Provides external service integration capabilities"
  - name: "api_client"
    type: "capability"
    description: "Provides HTTP/REST API client capabilities"
  - name: "data_transformation"
    type: "capability"
    description: "Provides data transformation and mapping capabilities"

# === DEPENDENCIES REQUIRED ===
requires_dependencies:
  - name: "protocol_http_client"
    type: "protocol"
    description: "HTTP client protocol for REST API calls"
    optional: false
  - name: "protocol_database_client"
    type: "protocol"
    description: "Database client protocol for database operations"
    optional: true
  - name: "protocol_message_queue_client"
    type: "protocol"
    description: "Message queue client protocol"
    optional: true

# === METRICS ===
metrics:
  - name: "external_calls_total"
    type: "counter"
    description: "Total number of external service calls"
    labels: ["service_name", "operation", "status"]
  - name: "external_call_duration"
    type: "histogram"
    description: "Duration of external service calls"
    labels: ["service_name", "operation"]
    buckets: [50, 100, 500, 1000, 5000, 10000, 30000]
  - name: "circuit_breaker_state_changes"
    type: "counter"
    description: "Number of circuit breaker state changes"
    labels: ["service_name", "from_state", "to_state"]
  - name: "fallback_activations"
    type: "counter"
    description: "Number of fallback strategy activations"
    labels: ["service_name", "fallback_strategy"]
  - name: "external_service_availability"
    type: "gauge"
    description: "External service availability percentage"
    labels: ["service_name"]
  - name: "data_transformation_operations"
    type: "counter"
    description: "Number of data transformation operations"
    labels: ["source_format", "target_format", "transformation_type"]
  - name: "authentication_operations"
    type: "counter"
    description: "Number of authentication operations"
    labels: ["service_name", "auth_type", "success"]

# === INTEGRATION ===
integration:
  main_contract_field: "external_dependencies_configuration"
  mapping_strategy: "direct_embedding"
  backward_compatibility: true
