---
# ONEX Runtime Orchestrator Contract
#
# This contract defines the ONEX runtime itself as a node graph, proving the
# system is self-consistent. The runtime is built using the 4-node architecture:
# - Contract loading (Effect node)
# - Contract registry (Reducer node)
# - Node graph management (Reducer node)
# - Event dispatching (Orchestrator sub-workflows)
#
# Architecture:
# ┌─────────────────────────────────────────────────────────────────────────┐
# │                    RUNTIME AS NODE GRAPH                                 │
# ├─────────────────────────────────────────────────────────────────────────┤
# │                                                                          │
# │  runtime_orchestrator (NodeOrchestrator)                                │
# │  ├── contract_loader (NodeEffect)                                       │
# │  │   └── Scans contracts directory, emits loaded contracts              │
# │  ├── contract_registry (NodeReducer)                                    │
# │  │   └── FSM: empty → loading → ready                                   │
# │  │   └── Maintains registry of compiled contracts                       │
# │  ├── node_graph (NodeReducer)                                           │
# │  │   └── FSM: initializing → wiring → running → draining                │
# │  │   └── Maintains instantiated node graph                              │
# │  └── event_bus_wiring (NodeEffect)                                      │
# │      └── Wires nodes to event bus subscriptions                         │
# │                                                                          │
# └─────────────────────────────────────────────────────────────────────────┘
#
# Design Decisions:
#
# 1. RUNTIME EXCLUSION FROM HOT RELOAD
#    Runtime contracts (contracts/runtime/**) are EXCLUDED from hot reload
#    to prevent circular dependency: the runtime cannot reload its own definition
#    while running. This is a fundamental bootstrapping constraint, similar to
#    how an operating system kernel cannot hot-patch itself without a reboot.
#    The ONEX runtime must be stopped and restarted to apply changes to its
#    own contract definitions.
#
# 2. INTERNAL CONTRACT EXCLUSION
#    Contracts prefixed with underscore (_*.yaml) are excluded as they are
#    considered internal/partial contracts not meant for direct instantiation.
#    These are typically fragments or templates used by other contracts.
#
# Node Implementation (NO custom code needed):
#   from omnibase_core.nodes import NodeOrchestrator
#   class NodeONEXRuntime(NodeOrchestrator):
#       pass  # All logic driven by this YAML contract

# Contract Metadata
node_type: ORCHESTRATOR_GENERIC
contract_version: {major: 1, minor: 0, patch: 0}

# Workflow Coordination Subcontract
workflow_coordination:
  version: {major: 1, minor: 0, patch: 0}
  subcontract_version: {major: 1, minor: 0, patch: 0}

  # Workflow Definition: Runtime lifecycle management
  workflow_definition:
    # Workflow Metadata
    workflow_metadata:
      workflow_name: runtime_lifecycle
      workflow_version: {major: 1, minor: 0, patch: 0}
      description: ONEX runtime lifecycle management workflow - self-hosted runtime using 4-node architecture
      execution_mode: sequential  # Runtime startup must be sequential
      author: ONEX Framework
      tags:
        - runtime
        - self-hosted
        - lifecycle
        - kernel
      documentation_url: https://docs.onex.ai/runtime/orchestrator

    # Execution Graph: Runtime node relationships
    execution_graph:
      nodes:
        # ─────────────────────────────────────────────────────────────
        # EFFECT: Contract Loader
        # Scans filesystem for contract YAML files
        # ─────────────────────────────────────────────────────────────
        - node_id: contract_loader
          node_type: EFFECT_GENERIC
          node_name: Contract Loader
          description: Scans contracts directory and loads YAML contract files
          target_node_type: NodeContractLoaderEffect
          contract_ref: runtime/contract_loader_effect.yaml
          metadata:
            contracts_dir: "${env.ONEX_CONTRACTS_DIR:./contracts}"
            pattern: "**/*.yaml"
            exclude_patterns:
              # CRITICAL: Runtime contracts must be excluded from hot reload
              # to prevent circular dependency. The runtime cannot reload its
              # own contract definition while running - this is a bootstrapping
              # constraint similar to how an OS kernel cannot update itself
              # without a reboot. See "Design Decisions" in header comments.
              - "**/runtime/**"
              # Internal/partial contracts not meant for direct instantiation.
              # These are fragments or templates included by other contracts.
              - "**/_*.yaml"
            watch_mode: false
            scan_interval_ms: 300000

        # ─────────────────────────────────────────────────────────────
        # REDUCER: Contract Registry
        # Maintains state of loaded/compiled contracts
        # FSM: empty → loading → ready
        # ─────────────────────────────────────────────────────────────
        - node_id: contract_registry
          node_type: REDUCER_GENERIC
          node_name: Contract Registry
          description: Maintains registry of loaded and validated contracts
          target_node_type: NodeContractRegistryReducer
          contract_ref: runtime/contract_registry_reducer.yaml
          depends_on:
            - contract_loader
          metadata:
            max_contracts: 1000
            validation_strict: true
            cache_compiled_contracts: true

        # ─────────────────────────────────────────────────────────────
        # REDUCER: Node Graph Manager
        # Maintains instantiated node graph state
        # FSM: initializing → wiring → running → draining
        # ─────────────────────────────────────────────────────────────
        - node_id: node_graph
          node_type: REDUCER_GENERIC
          node_name: Node Graph Manager
          description: Maintains the instantiated node graph based on loaded contracts
          target_node_type: NodeGraphManagerReducer
          contract_ref: runtime/node_graph_reducer.yaml
          depends_on:
            - contract_registry
          metadata:
            max_nodes: 500
            enable_hot_reload: true
            dependency_resolution: topological

        # ─────────────────────────────────────────────────────────────
        # EFFECT: Event Bus Wiring
        # Wires nodes to event bus subscriptions
        # ─────────────────────────────────────────────────────────────
        - node_id: event_bus_wiring
          node_type: EFFECT_GENERIC
          node_name: Event Bus Wiring
          description: Wires instantiated nodes to event bus subscriptions
          target_node_type: NodeEventBusWiringEffect
          contract_ref: runtime/event_bus_wiring_effect.yaml
          depends_on:
            - node_graph
          metadata:
            event_bus_type: "${env.ONEX_EVENT_BUS:inmemory}"
            subscription_timeout_ms: 5000
            retry_on_failure: true

      # Execution edges (derived from depends_on)
      edges:
        - from_node: contract_loader
          to_node: contract_registry
          edge_type: data_flow
          description: Discovered contracts flow to registry for validation
        - from_node: contract_registry
          to_node: node_graph
          edge_type: data_flow
          description: Validated contracts flow to node graph for instantiation
        - from_node: node_graph
          to_node: event_bus_wiring
          edge_type: data_flow
          description: Instantiated nodes flow to wiring for event subscriptions

    # Coordination Rules: Runtime startup coordination
    coordination_rules:
      # Sequential execution for startup (order matters)
      parallel_execution_allowed: false
      max_parallel_steps: 1

      # Failure recovery strategy
      failure_recovery_strategy: fail_fast  # Runtime startup must succeed
      max_retries: 3
      retry_backoff_ms: 2000
      retry_backoff_multiplier: 2.0

      # Timeout configuration
      timeout_ms: 120000  # 2 minutes total startup timeout
      step_timeout_ms: 30000  # 30 seconds per step

      # Dependency resolution
      dependency_resolution_enabled: true
      detect_cycles: true
      fail_on_cycle: true

      # Runtime must fully start
      allow_partial_completion: false
      min_required_steps_completion_percent: 100.0

      # Resource constraints for runtime
      resource_constraints:
        max_memory_mb: 512
        max_cpu_cores: 2

      # Monitoring and observability
      emit_step_metrics: true
      emit_workflow_events: true
      emit_dependency_graph: true

  # Lifecycle configuration for runtime
  lifecycle:
    startup_sequence:
      - contract_loader
      - contract_registry
      - node_graph
      - event_bus_wiring
    shutdown_sequence:
      - event_bus_wiring
      - node_graph
      - contract_registry
      - contract_loader
    health_check_interval_ms: 30000
    graceful_shutdown_timeout_ms: 60000

  # Event subscriptions for runtime management
  subscriptions:
    - topic: runtime.startup
      description: Trigger runtime startup sequence
    - topic: runtime.shutdown
      description: Trigger graceful shutdown sequence
    - topic: runtime.contracts.reload
      description: Trigger contract reload without full restart

  # Events published by runtime
  publications:
    - topic: runtime.ready
      description: Runtime is fully initialized and ready
      payload_schema: ModelRuntimeReadyEvent
    - topic: runtime.shutting_down
      description: Runtime is beginning shutdown sequence
      payload_schema: ModelRuntimeShutdownEvent
    - topic: runtime.error
      description: Runtime encountered a critical error
      payload_schema: ModelRuntimeErrorEvent

# ─────────────────────────────────────────────────────────────────────────────
# Timing Constraints Validation
# ─────────────────────────────────────────────────────────────────────────────
# All retry policies have been validated to ensure worst-case total retry time
# does not exceed operation timeout. This prevents infinite retry loops and
# ensures predictable failure behavior.
#
# Validation Methodology:
#   For exponential backoff: sum(base_delay * (2^i)) for i in 0..(max_retries-1)
#   Then apply jitter_factor: total * (1 + jitter_factor) for worst case
#   Delays are capped at max_delay_ms when specified
#
# Validation Date: 2025-12-08
# Linear Ticket: OMN-467
# ─────────────────────────────────────────────────────────────────────────────
timing_constraints:
  documentation: |
    All retry policies have been validated to ensure worst-case total
    retry time does not exceed operation timeout. This prevents infinite
    retry loops and ensures predictable failure behavior.

    Formula: sum(min(base_delay * 2^i, max_delay)) * (1 + jitter_factor)
    for i in 0..(max_retries-1)

  validations:
    # contract_loader_effect.yaml - scan_contracts_directory
    - operation: contract_loader.scan_contracts_directory
      contract_ref: runtime/contract_loader_effect.yaml
      timeout_ms: 60000
      retry_config:
        max_retries: 5
        base_delay_ms: 500
        max_delay_ms: 5000
        backoff_strategy: exponential
        jitter_factor: 0.15
      calculation: "500 + 1000 + 2000 + 4000 + 5000(capped) = 12500ms * 1.15 = 14375ms"
      worst_case_retry_ms: 14375
      margin_ms: 45625
      margin_percent: 76.0
      status: PASS

    # contract_loader_effect.yaml - read_contract_file
    - operation: contract_loader.read_contract_file
      contract_ref: runtime/contract_loader_effect.yaml
      timeout_ms: 15000
      retry_config:
        max_retries: 3
        base_delay_ms: 200
        max_delay_ms: 2000
        backoff_strategy: exponential
        jitter_factor: 0.1
      calculation: "200 + 400 + 800 = 1400ms * 1.1 = 1540ms"
      worst_case_retry_ms: 1540
      margin_ms: 13460
      margin_percent: 89.7
      status: PASS

    # event_bus_wiring_effect.yaml - event_bus_wiring
    - operation: event_bus_wiring.subscribe
      contract_ref: runtime/event_bus_wiring_effect.yaml
      timeout_ms: 60000
      retry_config:
        max_retries: 3
        base_delay_ms: 1000
        max_delay_ms: 10000
        backoff_strategy: exponential
        jitter_factor: 0.1
      calculation: "1000 + 2000 + 4000 = 7000ms * 1.1 = 7700ms"
      worst_case_retry_ms: 7700
      margin_ms: 52300
      margin_percent: 87.2
      status: PASS

    # runtime_orchestrator.yaml - coordination_rules (step-level retries)
    - operation: runtime_orchestrator.step_retry
      contract_ref: runtime/runtime_orchestrator.yaml
      timeout_ms: 30000  # step_timeout_ms
      retry_config:
        max_retries: 3
        base_delay_ms: 2000
        backoff_strategy: exponential  # multiplier: 2.0
        jitter_factor: 0.0  # No jitter specified
      calculation: "2000 + 4000 + 8000 = 14000ms"
      worst_case_retry_ms: 14000
      margin_ms: 16000
      margin_percent: 53.3
      status: PASS

  # Aggregate workflow timing
  workflow_timing:
    total_workflow_timeout_ms: 120000  # 2 minutes
    step_timeout_ms: 30000  # 30 seconds per step
    total_steps: 4  # contract_loader, contract_registry, node_graph, event_bus_wiring
    worst_case_sequential_execution_ms: 120000  # 4 steps * 30s = 120s (at limit)
    note: |
      The workflow timeout equals the sum of step timeouts (4 * 30s = 120s).
      This is acceptable because steps execute sequentially and each step
      has sufficient retry margin within its own timeout.

  # Notes on REDUCER contracts
  reducer_notes: |
    contract_registry_reducer.yaml and node_graph_reducer.yaml do not define
    explicit retry policies. These REDUCER nodes use FSM state transitions
    with short action timeouts (100ms-5000ms). Retry behavior for these nodes
    is managed at the orchestrator level via coordination_rules.

# Metadata
metadata:
  version: {major: 1, minor: 0, patch: 0}
  author: ONEX Framework
  description: Self-hosted ONEX runtime orchestrator using 4-node architecture
  tags:
    - orchestrator
    - runtime
    - kernel
    - self-hosted
    - lifecycle
  documentation_url: https://docs.onex.ai/runtime/orchestrator
  linear_ticket: OMN-467

  # Design Decisions Documentation
  # These decisions are architectural constraints that affect runtime behavior
  design_decisions:
    - decision: runtime_exclusion
      rationale: |
        Runtime contracts (contracts/runtime/**) are excluded from the contract
        hot reload mechanism. This is a fundamental bootstrapping constraint:
        the runtime orchestrator cannot reload its own definition while running.

        Similar to how an operating system kernel cannot hot-patch itself without
        a reboot, the ONEX runtime must be stopped and restarted to apply changes
        to its own contract definitions.

        This exclusion prevents:
        1. Circular dependency during contract loading
        2. Undefined behavior from partial runtime state during reload
        3. Potential infinite recursion if runtime contracts trigger reloads
      alternatives_considered:
        - "Two-phase reload with runtime handoff (too complex for MVP)"
        - "Versioned runtime contracts with migration (future consideration)"
        - "Shadow runtime that takes over during reload (resource intensive)"
      related_patterns:
        - "OS kernel hot-patching constraints"
        - "JVM class reloading limitations"
        - "Database schema migration patterns"

    - decision: internal_contract_exclusion
      rationale: |
        Contracts prefixed with underscore (_*.yaml) are treated as internal
        or partial contracts not meant for direct instantiation. These serve
        as building blocks or templates that are included by other contracts.

        This follows common conventions from Python (_ prefix for private),
        filesystem conventions (hidden files), and allows for contract
        composition without polluting the registry with fragments.
      alternatives_considered:
        - "Separate 'fragments/' directory (adds complexity)"
        - "Explicit 'fragment: true' field (requires schema changes)"
