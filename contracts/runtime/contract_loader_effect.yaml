---
# ONEX Runtime: Contract Loader Effect Node
#
# This EFFECT node scans the filesystem for contract YAML files and emits
# discovered contracts for the contract registry to process.
#
# Node Implementation (NO custom code needed):
#   from omnibase_core.nodes import NodeEffect
#   class NodeContractLoaderEffect(NodeEffect):
#       pass  # All logic driven by this YAML contract
#
# Features Demonstrated:
# - Filesystem handler for directory scanning
# - Watch mode for real-time contract discovery
# - Pattern-based file filtering
# - Retry policy for robustness

# Contract Metadata
node_type: EFFECT_GENERIC
contract_version: {major: 1, minor: 1, patch: 0}
# Fingerprint: SHA-256 hash of canonical contract content (node_type, effect_operations, metadata.description)
fingerprint: "v1.1.0:0ce5689d8ebd"
# Effect Subcontract
# NOTE: This contract uses `effect_operations` (multi-operation schema) rather than
# `effect` (single-operation schema) because it defines multiple filesystem operations
# (scan_contracts_directory, read_contract_file). Contracts with a single operation
# use the simpler `effect:` key (e.g., event_bus_wiring_effect.yaml).
effect_operations:
  version: {major: 1, minor: 1, patch: 0}
  subcontract_version: {major: 1, minor: 1, patch: 0}

  # Execution configuration
  execution_mode: sequential_abort  # Abort on first failure

  # Default resilience settings
  default_retry_policy:
    enabled: true
    max_retries: 3
    backoff_strategy: exponential
    base_delay_ms: 1000
    max_delay_ms: 10000
    jitter_factor: 0.1
    retryable_errors:
      - ENOENT
      - EACCES
      - ETIMEDOUT
      - ECONNRESET

  # Operations
  operations:
    # Primary operation: Scan contracts directory
    - operation_name: scan_contracts_directory
      description: Scan configured directory for contract YAML files
      idempotent: true  # Read-only operation

      io_config:
        handler_type: filesystem
        file_path_template: "${env.ONEX_CONTRACTS_DIR:./contracts}"
        operation: read
        timeout_ms: 30000
        atomic: false  # Read operations don't need atomicity
        create_dirs: false  # Don't create dirs for read
        encoding: utf-8

        # Security: Filesystem Path Sandboxing
        # Rationale: Prevent path traversal attacks and restrict filesystem access
        # to authorized directories only. This protects against:
        # - Directory traversal via ".." sequences
        # - Access to sensitive system directories (/etc, /var, /home)
        # - Symlink escape attacks that could access files outside the sandbox
        # - Arbitrary absolute path injection via environment variables
        security:
          allowed_base_paths:
            - "${env.ONEX_CONTRACTS_DIR:./contracts}"
            - "./contracts"
          path_validation:
            enabled: true
            deny_patterns:
              - ".."
              - "/etc"
              - "/var"
              - "/home"
              - "~"
              - "/proc"
              - "/sys"
              - "/dev"
            deny_absolute_paths: true  # Only allow relative paths within sandbox
            deny_symlink_escape: true  # Prevent symlinks pointing outside base paths

      # Scanning configuration (metadata for handler)
      metadata:
        scan_mode: directory
        pattern: "**/*.yaml"
        exclude_patterns:
          - "**/runtime/**"  # Don't reload runtime contracts
          - "**/_*.yaml"  # Skip disabled contracts (underscore prefix)
          - "**/.*"  # Skip hidden files
          - "**/__pycache__/**"  # Skip Python cache directories
        watch_mode: true
        watch_debounce_ms: 500
        recursive: true
        follow_symlinks: false

      response_handling:
        success_codes: [200]
        extract_fields:
          discovered_files: "$.files"
          file_count: "$.count"
          scan_timestamp: "$.timestamp"
        fail_on_empty: false  # Empty contracts dir is valid (initial state)
        extraction_engine: jsonpath

      # Override retry for scan operation
      # Timing Validation: 500 + 1000 + 2000 + 4000 + 5000(capped) = 12500ms * 1.15 = 14375ms
      # Worst case retry (14375ms) << timeout (60000ms) - PASS (76% margin)
      retry_policy:
        enabled: true
        max_retries: 5
        backoff_strategy: exponential
        base_delay_ms: 500
        max_delay_ms: 5000
        jitter_factor: 0.15

      operation_timeout_ms: 60000  # 60 second timeout for directory scan

    # Secondary operation: Read individual contract file
    - operation_name: read_contract_file
      description: Read and return contents of a single contract file
      idempotent: true  # Read-only operation

      io_config:
        handler_type: filesystem
        file_path_template: "${input.file_path}"
        operation: read
        timeout_ms: 10000
        atomic: false
        create_dirs: false
        encoding: utf-8

        # Security: Filesystem Path Sandboxing for User-Provided Paths
        # Rationale: This operation accepts file paths from input, making it
        # especially vulnerable to path traversal and arbitrary file access attacks.
        # Strict sandboxing ensures users cannot read sensitive system files or
        # escape the contracts directory boundary.
        security:
          allowed_base_paths:
            - "${env.ONEX_CONTRACTS_DIR:./contracts}"
            - "./contracts"
          path_validation:
            enabled: true
            deny_patterns:
              - ".."
              - "/etc"
              - "/var"
              - "/home"
              - "~"
              - "/proc"
              - "/sys"
              - "/dev"
            deny_absolute_paths: true  # Only allow relative paths within sandbox
            deny_symlink_escape: true  # Prevent symlinks pointing outside base paths
          # Additional validation for user-provided file paths
          require_path_under_base: true  # File path MUST resolve under allowed_base_paths
          validate_extension:
            - ".yaml"
            - ".yml"

      response_handling:
        success_codes: [200]
        extract_fields:
          content: "$.content"
          file_path: "$.path"
          file_size: "$.size"
          modified_at: "$.modified_at"
        fail_on_empty: true  # Empty contract file is an error
        extraction_engine: jsonpath

      # Timing Validation: 200 + 400 + 800 = 1400ms * 1.1 = 1540ms
      # Worst case retry (1540ms) << timeout (15000ms) - PASS (90% margin)
      retry_policy:
        enabled: true
        max_retries: 3
        backoff_strategy: exponential
        base_delay_ms: 200
        max_delay_ms: 2000
        jitter_factor: 0.1

      operation_timeout_ms: 15000  # 15 second timeout per file

  # Circuit breaker for filesystem operations
  circuit_breaker:
    enabled: true
    failure_threshold: 10
    success_threshold: 3
    timeout_ms: 30000
    half_open_requests: 5

  # Observability
  observability:
    log_request: true
    log_response: false  # Contract contents may be large
    emit_metrics: true
    trace_propagation: true

# v1.1.0 Required Fields
handlers:
  required: []
  optional:
    - type: ProtocolLogger
      version: {major: 1, minor: 0, patch: 0}
    - type: ProtocolFileSystem
      version: {major: 1, minor: 0, patch: 0}

profile_tags:
  - runtime
  - effect
  - contracts
  - discovery

subscriptions:
  topics: []

# Metadata
metadata:
  version: {major: 1, minor: 1, patch: 0}
  author: ONEX Framework Team
  description: Contract loader effect node for scanning and discovering ONEX contract YAML files from
    the filesystem
  tags:
    - effect
    - filesystem
    - declarative
    - contracts
    - discovery
    - runtime
    - loader
  documentation_url: https://docs.onex.ai/effects/contract-loader
