---
node_type: REDUCER_GENERIC
contract_version: {major: 1, minor: 0, patch: 0}
state_transitions:
  version: {major: 1, minor: 0, patch: 0}
  state_machine_version: {major: 1, minor: 0, patch: 0}
  state_machine_name: node_graph_fsm
  description: Maintains instantiated node graph state with FSM-driven lifecycle management
  initial_state: initializing
  states:
    - state_name: initializing
      description: Setting up the node graph - loading registry and preparing infrastructure
      entry_actions:
        - load_node_registry
        - initialize_graph_structure
        - prepare_dependency_resolver
      exit_actions:
        - log_initialization_complete
      is_terminal: false
      metadata:
        ui_color: '#3B82F6'
        icon: loader
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: wiring
      description: Connecting nodes based on dependencies and establishing communication channels
      entry_actions:
        - resolve_node_dependencies
        - establish_node_connections
        - validate_connection_graph
      exit_actions:
        - finalize_wiring
        - log_wiring_statistics
      is_terminal: false
      metadata:
        ui_color: '#8B5CF6'
        icon: git-branch
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: running
      description: Node graph is active and processing - all nodes are wired and operational
      entry_actions:
        - activate_all_nodes
        - start_health_monitoring
        - emit_graph_ready_event
      exit_actions:
        - stop_health_monitoring
        - prepare_for_shutdown
      is_terminal: false
      metadata:
        ui_color: '#10B981'
        icon: play
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: draining
      description: Gracefully shutting down - allowing in-flight operations to complete
      entry_actions:
        - stop_accepting_new_work
        - notify_nodes_of_shutdown
        - start_drain_timer
      exit_actions:
        - force_complete_remaining_work
        - log_drain_statistics
      is_terminal: false
      metadata:
        ui_color: '#FBBF24'
        icon: hourglass
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: stopped
      description: Node graph is fully stopped - all resources released
      entry_actions:
        - release_all_resources
        - disconnect_all_nodes
        - emit_graph_stopped_event
        - cleanup_graph_state
      exit_actions: []
      is_terminal: true
      metadata:
        ui_color: '#6B7280'
        icon: stop-circle
        idempotency_note: |
          All entry_actions MUST be idempotent as this state can be reached
          from ANY state via fatal_error or timeout wildcards (from_state: '*').

          Idempotency guarantees for each action:
          - release_all_resources: Safe to call multiple times (no-op if already released)
          - disconnect_all_nodes: Safe to call on already-disconnected nodes
          - emit_graph_stopped_event: Event bus handles duplicate events gracefully
          - cleanup_graph_state: Clears state to empty (idempotent by design)

          This is critical because wildcard transitions can trigger from any
          non-terminal state, and the stopped state may be entered multiple
          times during error recovery or restart scenarios.
      version: {major: 1, minor: 0, patch: 0}
      state_type: terminal
  transitions:
    - transition_name: registry_ready
      from_state: initializing
      to_state: wiring
      trigger: registry_ready
      description: Node registry is loaded and ready, begin wiring nodes
      conditions:
        - condition_name: registry_loaded
          expression: node_registry is_not_empty
          required: true
          description: Node registry must contain at least one node definition
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
        - condition_name: no_registry_errors
          expression: registry_errors equals 0
          required: true
          description: Registry must load without errors
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: emit_wiring_started
          action_type: event
          is_critical: false
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: snapshot_registry_state
          action_type: data_capture
          is_critical: true
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: wiring_complete
      from_state: wiring
      to_state: running
      trigger: wiring_complete
      description: All node connections established successfully, activate graph
      conditions:
        - condition_name: all_nodes_wired
          expression: unwired_nodes equals 0
          required: true
          description: All nodes must be successfully wired
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
        - condition_name: no_circular_dependencies
          expression: circular_dependency_count equals 0
          required: true
          description: Graph must not contain circular dependencies
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: emit_graph_running
          action_type: event
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: log_graph_topology
          action_type: logging
          is_critical: false
          timeout_ms: 500
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: shutdown_requested
      from_state: running
      to_state: draining
      trigger: shutdown_requested
      description: Shutdown signal received, begin graceful drain
      conditions: []
      actions:
        - action_name: emit_drain_started
          action_type: event
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: log_shutdown_request
          action_type: logging
          is_critical: false
          timeout_ms: 500
          version: {major: 1, minor: 0, patch: 0}
        - action_name: capture_in_flight_operations
          action_type: data_capture
          is_critical: true
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: drain_complete
      from_state: draining
      to_state: stopped
      trigger: drain_complete
      description: All in-flight operations completed, fully stop the graph
      conditions:
        - condition_name: no_pending_operations
          expression: pending_operations equals 0
          required: true
          description: All pending operations must complete before stopping
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: persist_final_state
          action_type: persistence
          is_critical: true
          timeout_ms: 5000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emit_graph_stopped
          action_type: event
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: fatal_error
      from_state: '*'
      to_state: stopped
      trigger: fatal_error
      description: Critical error occurred, immediately stop the graph from any state
      conditions: []
      actions:
        - action_name: log_fatal_error
          action_type: logging
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emit_fatal_error_alert
          action_type: alert
          is_critical: true
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: capture_error_diagnostics
          action_type: data_capture
          is_critical: false
          timeout_ms: 3000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emergency_resource_cleanup
          action_type: cleanup
          is_critical: true
          timeout_ms: 5000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: handle_timeout
      from_state: '*'
      to_state: stopped
      trigger: timeout
      description: Operation timeout from any non-terminal state - stop the graph
      conditions: []
      actions:
        - action_name: log_timeout_event
          action_type: logging
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emit_timeout_alert
          action_type: alert
          is_critical: false
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
  terminal_states:
    - stopped
  error_states:
    - stopped
  persistence_enabled: true
  recovery_enabled: true
  operations:
    - operation_name: force_stop
      description: Force immediate stop of the node graph without graceful drain
      trigger: force_stop
      target_state: stopped
      requires_permission: true
      is_destructive: true
      rollback_transitions: []
      version: {major: 1, minor: 0, patch: 0}
      operation_type: administrative
    - operation_name: restart_graph
      description: Restart the node graph from stopped state
      trigger: restart
      target_state: initializing
      requires_permission: true
      is_destructive: false
      rollback_transitions:
        - transition_name: rollback_restart
          from_state: initializing
          to_state: stopped
          trigger: undo_restart
      version: {major: 1, minor: 0, patch: 0}
      operation_type: administrative
    - operation_name: rewire_graph
      description: Re-establish node connections while running (hot rewiring)
      trigger: rewire
      target_state: wiring
      requires_permission: true
      is_destructive: false
      rollback_transitions:
        - transition_name: rollback_rewire
          from_state: wiring
          to_state: running
          trigger: undo_rewire
      version: {major: 1, minor: 0, patch: 0}
      operation_type: administrative
metadata:
  version: {major: 1, minor: 0, patch: 0}
  author: ONEX Framework Team
  description: Node graph lifecycle reducer using FSM pattern for ONEX runtime self-hosting
  tags:
    - reducer
    - fsm
    - declarative
    - node-graph
    - runtime
    - lifecycle
  documentation_url: https://docs.onex.ai/reducers/node-graph

# Testing Guidance for Wildcard Transitions
# =========================================
# This section documents required integration tests for wildcard transitions
# (from_state: '*') which can trigger from any non-terminal state.
testing_guidance:
  wildcard_transition_safety:
    description: |
      Wildcard transitions (from_state: '*') are used for fatal_error and timeout
      handling. These transitions bypass normal state flow and must be safe to
      execute from ANY non-terminal state. The target state (stopped) must have
      idempotent entry_actions since it can be reached via multiple paths.

    applicable_transitions:
      - fatal_error
      - handle_timeout

  integration_tests_required:
    fatal_error_from_all_states:
      description: Test fatal_error transition from each non-terminal state
      priority: critical
      test_cases:
        - test_name: fatal_error_from_initializing
          from_state: initializing
          trigger: fatal_error
          expected_outcome:
            final_state: stopped
            actions_executed:
              - log_fatal_error
              - emit_fatal_error_alert
              - capture_error_diagnostics
              - emergency_resource_cleanup
            entry_actions_executed:
              - release_all_resources
              - disconnect_all_nodes
              - emit_graph_stopped_event
              - cleanup_graph_state
            verification:
              - All resources released (verify via resource tracker)
              - Error logged with full context
              - Graph state is clean

        - test_name: fatal_error_from_wiring
          from_state: wiring
          trigger: fatal_error
          expected_outcome:
            final_state: stopped
            verification:
              - Partial wiring cleaned up
              - Pending connections cancelled
              - Error logged with wiring context

        - test_name: fatal_error_from_running
          from_state: running
          trigger: fatal_error
          expected_outcome:
            final_state: stopped
            verification:
              - Health monitoring stopped
              - All active nodes deactivated
              - In-flight operations captured in error diagnostics

        - test_name: fatal_error_from_draining
          from_state: draining
          trigger: fatal_error
          expected_outcome:
            final_state: stopped
            verification:
              - Drain aborted immediately
              - Remaining work force-completed
              - Drain timer cancelled

    timeout_from_all_states:
      description: Test timeout transition from each non-terminal state
      priority: high
      test_cases:
        - test_name: timeout_from_initializing
          from_state: initializing
          trigger: timeout
          expected_outcome:
            final_state: stopped
            verification:
              - Timeout event logged with state context
              - Initialization aborted cleanly

        - test_name: timeout_from_wiring
          from_state: wiring
          trigger: timeout
          expected_outcome:
            final_state: stopped
            verification:
              - Timeout event logged
              - Wiring operation aborted
              - Partial connections cleaned up

        - test_name: timeout_from_running
          from_state: running
          trigger: timeout
          expected_outcome:
            final_state: stopped
            verification:
              - Timeout alert emitted
              - Running state cleanup performed

        - test_name: timeout_from_draining
          from_state: draining
          trigger: timeout
          expected_outcome:
            final_state: stopped
            verification:
              - Drain timeout handled
              - Remaining work force-stopped

    idempotency_verification:
      description: Verify entry_actions can be called multiple times safely
      priority: critical
      test_cases:
        - test_name: double_fatal_error_idempotency
          approach: |
            Trigger fatal_error transition, then trigger it again before
            entry_actions complete. Verify no exceptions, no resource leaks,
            and final state is consistent.
          verification:
            - No exceptions thrown on second fatal_error
            - Resources released exactly once (not double-freed)
            - Graph state is clean after both transitions

        - test_name: fatal_error_after_timeout
          approach: |
            Trigger timeout transition, then immediately trigger fatal_error.
            Verify both transitions handled gracefully.
          verification:
            - Both transitions execute without conflict
            - Final state is stopped
            - All cleanup actions idempotent

        - test_name: restart_after_fatal_error
          approach: |
            Trigger fatal_error to reach stopped state, then restart_graph
            operation, then fatal_error again. Verify full cycle works.
          verification:
            - Graph can restart after fatal_error
            - Second fatal_error works correctly
            - No accumulated state between cycles

    edge_cases:
      description: Additional edge case tests for robustness
      test_cases:
        - test_name: fatal_error_with_pending_actions
          description: |
            Trigger fatal_error while transition actions from a previous
            state change are still executing.
          verification:
            - Pending actions cancelled or completed
            - No orphaned resources
            - Consistent final state

        - test_name: concurrent_timeout_and_fatal_error
          description: |
            Trigger both timeout and fatal_error simultaneously from
            the same state.
          verification:
            - Only one transition executes
            - No race conditions
            - Consistent final state
