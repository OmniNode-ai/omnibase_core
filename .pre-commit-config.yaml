# ONEX Core Pre-commit Configuration
# Aligned with omnibase_3 parent project standards

repos:
  # YAML formatting (matching parent)
  - repo: https://github.com/google/yamlfmt
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        args: [--formatter, retain_line_breaks=true]
        exclude: ^work_tickets/

  # Essential file formatting (matching parent)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: end-of-file-fixer
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]

  # Python formatting (matching parent exactly)
  - repo: https://github.com/psf/black
    rev: 25.1.0
    hooks:
      - id: black
        args: [--line-length, "88", --target-version, py311]

  # Python imports (matching parent exactly)
  - repo: https://github.com/pycqa/isort
    rev: 6.0.1
    hooks:
      - id: isort
        args: [--profile, black, --line-length, "88"]

  # Type checking with mypy using poetry environment (matching parent)
  - repo: local
    hooks:
      - id: mypy-poetry
        name: mypy via poetry
        entry: poetry run mypy
        language: system
        types: [python]
        args: [--ignore-missing-imports, --show-error-codes, --no-strict-optional, --no-error-summary, --follow-imports=skip, --config-file=mypy.ini]
        # Focus on core framework components
        files: ^src/omnibase_core/(core|model|enums|exceptions|decorators).*\.py$
        # Exclude test files, examples, and problematic contract files until properly configured
        exclude: ^(tests/|src/omnibase_core/examples|src/omnibase_core/core/contracts/model_contract_effect).*\.py$

      # ONEX Contract Validation
      - id: validate-contracts
        name: ONEX Contract Validation
        entry: poetry run python scripts/validate-contracts.py
        language: system
        pass_filenames: false
        files: ^src/omnibase_core/(nodes|protocol|core).*\.py$
        stages: [commit]

      # Canary Node Unit Tests
      - id: canary-unit-tests
        name: Canary Node Unit Tests
        entry: python scripts/run-canary-tests.py
        language: system
        pass_filenames: false
        files: ^(src/omnibase_core/nodes/canary/|tests/unit/test_canary_nodes\.py).*$
        stages: [commit]

      # Union Usage Validation
      - id: validate-union-usage
        name: ONEX Union Usage Validation
        entry: python scripts/validate-union-usage.py --max-unions 7000
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        stages: [commit]

      # Pydantic Legacy Pattern Validation
      - id: validate-pydantic-patterns
        name: ONEX Pydantic Legacy Pattern Validation
        entry: python scripts/validate-pydantic-patterns.py --allow-errors 13
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        stages: [commit]

      # String Version Validation
      - id: validate-string-versions
        name: ONEX String Version Validation
        entry: poetry run python scripts/validate-string-versions.py
        language: system
        pass_filenames: true
        files: ^.*\.(yaml|yml)$
        stages: [commit]

      # Prevent Manual YAML Validation
      - id: validate-no-manual-yaml
        name: ONEX Prevent Manual YAML Validation
        entry: poetry run python scripts/validate-no-manual-yaml.py
        language: system
        pass_filenames: true
        files: ^.*\.py$
        exclude: ^scripts/validate-contracts\.py$ # Deprecated script, contains legacy YAML validation
        stages: [commit]

      # Backward Compatibility Anti-Pattern Detection
      - id: validate-no-backward-compatibility
        name: ONEX Backward Compatibility Anti-Pattern Detection
        entry: python scripts/validate-no-backward-compatibility.py
        language: system
        pass_filenames: true
        files: ^.*\.py$
        exclude: ^scripts/validate-no-backward-compatibility\.py$ # Exclude the validation script itself
        stages: [commit]

      # Repository structure validation (NEW)
      - id: validate-repository-structure
        name: Omni* Repository Structure Validation
        entry: python tools/validation/validate_structure.py
        args: ['.', 'omnibase_core']
        language: system
        always_run: true
        pass_filenames: false
        stages: [commit]

      # Naming convention validation (NEW)
      - id: validate-naming-conventions
        name: Omni* Naming Convention Validation
        entry: python tools/validation/validate_naming.py
        args: ['.']
        language: system
        types: [python]
        stages: [commit]

      # Optional type usage audit (NEW)
      - id: audit-optional-usage
        name: Omni* Optional Type Usage Audit
        entry: python tools/validation/audit_optional.py
        args: ['.']
        language: system
        types: [python]
        stages: [commit]

# Configuration
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes for omnibase_core

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_schedule: weekly
  submodules: false
