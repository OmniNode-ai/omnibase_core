# ONEX Core Pre-commit Configuration
# Uses shared ONEX hook templates to demonstrate ecosystem integration
#
# PERFORMANCE OPTIMIZATION NOTES:
# - MyPy enabled with strict configuration (0 errors, ~5-10s)
# - validate-naming-conventions takes ~14s on full codebase
# - Total pre-commit time target: <30s for comprehensive feedback
# - Use `pre-commit run --all-files` to test all hooks before pushing

repos:
  # YAML formatting (standard across ecosystem)
  # Configuration in .yamlfmt file (ecosystem-aligned settings)
  - repo: https://github.com/google/yamlfmt
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        exclude: ^(work_tickets/|tests/fixtures/validation/invalid/|\.github/workflows/|archived/)

  # Essential file formatting (standard across ecosystem)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^(\.github/workflows/|\.mcp\.json$)
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]

  # ONEX Python Development Hooks (from shared templates)
  # Order: black → isort → ruff → mypy (formatting before linting before type checking)
  - repo: local
    hooks:
      - id: black-format
        name: black (auto-format)
        entry: poetry run black
        language: system
        types: [python]
        args: [--line-length, "88", --target-version, py311]
        exclude: ^(tests/fixtures/validation/edge_cases/syntax_error\.py|\.github/workflows/|archived/).*$
        stages: [commit]

      - id: isort-format
        name: isort (auto-sort imports)
        entry: poetry run isort
        language: system
        types: [python]
        args: [--filter-files, --profile, black, --line-length, "88"]
        exclude: ^(tests/fixtures/validation/edge_cases/syntax_error\.py|\.github/workflows/|archived/)
        stages: [commit]

      - id: ruff-fix
        name: ruff (auto-fix linting issues)
        entry: poetry run ruff check --fix
        language: system
        types: [python]
        exclude: ^(tests/fixtures/validation/edge_cases/syntax_error\.py|\.github/workflows/|archived/).*$
        stages: [commit]

      - id: mypy-type-check
        name: mypy (type checking - strict)
        entry: poetry run mypy
        language: system
        types: [python]
        args: [--show-error-codes, --no-error-summary]
        files: ^src/omnibase_core/.*\.py$
        exclude: ^(tests/|src/omnibase_core/examples|archive/|archived/).*\.py$
        stages: [commit]

      # Cleanup: Clear tmp/ directory before commits
      # Prevents accumulation of temporary files from custom commands
      - id: clean-tmp-directory
        name: Clean tmp directory
        entry: bash -c "rm -rf tmp/* 2>/dev/null || true"
        language: system
        always_run: true
        pass_filenames: false
        stages: [commit]

  # ONEX Framework Validation (from shared templates)
  - repo: local
    hooks:

      # ONEX Core Framework Validation (SHARED HOOKS)
      - id: validate-repository-structure
        name: ONEX Repository Structure Validation
        entry: poetry run python scripts/validation/validate_structure.py
        args: ['.', 'omnibase_core']
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

      - id: validate-naming-conventions
        name: ONEX Naming Convention Validation
        entry: poetry run python scripts/validation/validate_naming.py
        args: ['src/']
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        exclude: ^(tests/|archive/|archived/|scripts/validation/).*\.py$
        stages: [pre-commit]
        # Note: Takes ~14s on full codebase - consider optimizing script for incremental checks
        # Architectural exemptions documented in validate_naming.py ARCHITECTURAL_EXEMPTIONS

      - id: validate-file-locations
        name: ONEX File Location Enforcement
        entry: poetry run python scripts/validation/validate-file-locations.py
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/).*\.py$
        stages: [pre-commit]

      - id: validate-no-duplicate-dirs
        name: ONEX Duplicate Directory Detection
        entry: poetry run python scripts/validation/validate-no-duplicate-dirs.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: validate-no-duplicate-models
        name: ONEX Duplicate Model Filename Prevention
        entry: poetry run python scripts/validation/validate-no-duplicate-models.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: validate-no-empty-directories
        name: ONEX Empty Directory Prevention
        entry: poetry run python scripts/validation/validate-no-empty-directories.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # String Version Anti-Pattern Detection
      # Prevents use of ModelSemVer.parse("X.Y.Z") and direct version string literals
      # Enforces structured versions: ModelSemVer(1, 0, 0) instead of "1.0.0"
      # Catches: ModelSemVer.parse(), string literals, flat YAML versions
      # Allows: Docstrings, regex patterns (r"..."), test fixtures, log messages
      # See: docs/ANTI_PATTERNS.md#string-version-literals
      - id: validate-string-versions
        name: ONEX String Version Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-string-versions.py
        language: system
        pass_filenames: true
        files: ^.*\.(py|yaml|yml)$
        exclude: ^(tests/fixtures/validation/|archived/|archive/)
        stages: [pre-commit]

      - id: validate-archived-imports
        name: ONEX Archived Path Import Prevention
        entry: poetry run python scripts/validation/validate-archived-imports.py
        args: ['src/']
        language: system
        pass_filenames: false
        files: ^.*\.py$
        exclude: ^(archived/|archive/|tests/fixtures/validation/).*$
        stages: [pre-commit]

      - id: validate-no-backward-compatibility
        name: ONEX Backward Compatibility Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-no-backward-compatibility.py
        args: ['-d', 'src/']
        language: system
        pass_filenames: false
        files: ^.*\.py$
        exclude: ^(scripts/validation/validate-no-backward-compatibility\.py|archived/.*)$
        stages: [pre-commit]

      - id: validate-no-manual-yaml
        name: ONEX Manual YAML Prevention
        entry: poetry run python scripts/validation/validate-no-manual-yaml.py
        language: system
        pass_filenames: true
        files: ^.*\.py$
        exclude: ^(scripts/validation/validate-contracts\.py|scripts/validation/validate-string-versions\.py|scripts/validation/check_stub_implementations\.py|scripts/validation/validate-no-manual-yaml\.py|src/omnibase_core/utils/safe_yaml_loader\.py|src/omnibase_core/utils/util_safe_yaml_loader\.py|src/omnibase_core/validation/contracts\.py|src/omnibase_core/validation/contract_validator\.py|src/omnibase_core/discovery/mixin_discovery\.py|tests/fixtures/validation/)
        stages: [pre-commit]

      # ONEX Python Pattern Validation (SHARED HOOKS)
      - id: validate-pydantic-patterns
        name: ONEX Pydantic Pattern Validation
        entry: poetry run python scripts/validation/validate-pydantic-patterns.py
        args: ['--allow-errors', '13']
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        stages: [pre-commit]

      - id: validate-union-usage
        name: ONEX Union Usage Validation
        entry: poetry run python scripts/validation/validate-union-usage.py
        args: ['--allow-invalid', '234']
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        stages: [pre-commit]

      # Repository-specific validation (omnibase_core only)
      - id: validate-contracts
        name: ONEX Contract Validation
        entry: poetry run python scripts/validation/validate-contracts.py
        language: system
        pass_filenames: false
        files: ^src/omnibase_core/(nodes|protocol|core).*\.py$
        stages: [pre-commit]

      - id: audit-optional-usage
        name: ONEX Optional Type Usage Audit
        entry: poetry run python scripts/validation/audit_optional.py
        args: ['.']
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

      - id: check-stub-implementations
        name: ONEX Stub Implementation Detector
        entry: poetry run python scripts/validation/check_stub_implementations.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|examples/prototypes/).*\.py$
        stages: [pre-commit]

      - id: check-no-fallbacks
        name: ONEX No Fallback Patterns Validation
        entry: poetry run python scripts/validation/check_no_fallbacks.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: check-error-raising
        name: ONEX Error Raising Validation
        entry: poetry run python scripts/validation/check_error_raising.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: validate-no-enhancement-prefixes
        name: ONEX Enhancement Prefix Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-no-enhancement-prefixes.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: onex-single-class-per-file
        name: ONEX Single Class Per File
        entry: poetry run python scripts/validation/validate-single-class-per-file.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/|src/omnibase_core/utils/util_singleton_holders\.py|src/omnibase_core/models/core/model_action_config_value\.py).*\.py$
        stages: [pre-commit]

      - id: validate-enum-model-imports
        name: ONEX Enum/Model Import Prevention
        entry: poetry run python scripts/validation/validate-enum-model-imports.py
        language: system
        pass_filenames: true
        files: ^src/omnibase_core/enums/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: validate-typeddict-patterns
        name: ONEX TypedDict Pattern Validation
        entry: poetry run python scripts/validation/validate-typeddict-patterns.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # dict[str, Any] Anti-Pattern Detection
      # Enforces strong typing by detecting dict[str, Any] usage
      # TECHNICAL DEBT: Current baseline is 842 violations (2025-12-05)
      # Goal: Reduce to 0 over time by replacing with TypedDict or specific models
      # Track progress by lowering --max-violations as fixes are applied
      - id: validate-dict-any-usage
        name: ONEX dict[str, Any] Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-dict-any-usage.py
        args: [--max-violations, "850"]
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: no-pydantic-bypass-in-prod
        name: ONEX Pydantic Bypass Prevention
        entry: poetry run python scripts/validation/validate-no-pydantic-bypass.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # Security: Secret Detection (prevents hardcoded secrets)
      - id: validate-secrets
        name: ONEX Secret Detection
        entry: poetry run python scripts/validation/validate-secrets.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # Security: Hardcoded Environment Variable Prevention
      - id: validate-hardcoded-env-vars
        name: ONEX Hardcoded Environment Variable Prevention
        entry: poetry run python scripts/validation/validate-hardcoded-env-vars.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: validate-exception-handling
        name: ONEX Exception Handling Validation
        entry: poetry run python scripts/validation/validate-exception-handling.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # ONEX Model-Primitive Union Prevention (PR#59 follow-up)
      # Prevents Union types mixing models and primitives that cause Pydantic
      # validation race conditions in parallel execution (pytest-xdist)
      - id: validate-no-model-primitive-unions
        name: ONEX Model-Primitive Union Prevention
        entry: ./scripts/validate-no-model-primitive-unions.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # Documentation link validation - prevents broken links in CI
      - id: validate-doc-links
        name: ONEX Documentation Link Validation
        entry: poetry run python scripts/validation/validate-doc-links.py
        args: [--fix-case]
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # Smoke tests - fast critical path validation (~3s)
      # Runs foundational tests (enums, errors) for immediate feedback
      # Full test suite (10k+ tests) runs in CI with parallel execution
      - id: pytest-smoke-tests
        name: Run Smoke Tests (enums + errors)
        entry: poetry run pytest
        language: system
        pass_filenames: false
        always_run: true
        args:
          - tests/unit/enums
          - tests/unit/errors
          - --maxfail=5
          - -x
          - --tb=short
          - -q
          - -p
          - no:rerunfailures
        stages: [pre-commit]

# Configuration
default_install_hook_types: [pre-commit]
default_stages: [pre-commit]
fail_fast: false
# Note: minimum_pre_commit_version removed to avoid string version anti-pattern
# Project requires pre-commit >= 2.15.0 (document in README if needed)

# Performance optimization: Enable parallel execution
# This significantly reduces total execution time
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes for omnibase_core

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_schedule: weekly
  submodules: false
