---
# ONEX Core Pre-commit Configuration
# Uses shared ONEX hook templates to demonstrate ecosystem integration
#
# PERFORMANCE OPTIMIZATION (2025-12):
# ====================================
# Two-stage validation strategy for optimal developer experience:
#
# PRE-COMMIT (target: <15 seconds):
#   - Formatting (ruff format/fix, yamlfmt)
#   - Basic file checks (whitespace, large files, merge conflicts)
#   - Quick structural validations (empty dirs, duplicates)
#   - Security checks (secrets, env vars)
#   - Fast pattern validations
#
# PRE-PUSH (quick validation before sharing):
#   - mypy type checking (changed files only, ~1-5s)
#   - validate-naming-conventions (~14s)
#   - Documentation link validation
#   - Protocol UUID enforcement (~6s)
#
# NOTE: AST-based validators (pydantic, union, dict-any, optional) now use
# pass_filenames=true - they only check staged files, not entire codebase.
#
# USAGE:
#   pre-commit install                    # Install pre-commit hooks
#   pre-commit install --hook-type pre-push  # Install pre-push hooks
#   pre-commit run --all-files            # Run all pre-commit hooks
#   pre-commit run --all-files --hook-stage pre-push  # Run pre-push hooks

repos:
  # YAML formatting (standard across ecosystem)
  # Configuration in .yamlfmt file (ecosystem-aligned settings)
  - repo: https://github.com/google/yamlfmt
    rev: v0.17.2
    hooks:
      - id: yamlfmt
        exclude: ^(work_tickets/|tests/fixtures/validation/invalid/|\.github/workflows/|archived/)

  # Essential file formatting (standard across ecosystem)
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: ^\.github/workflows/
      - id: end-of-file-fixer
        exclude: ^(\.github/workflows/|\.mcp\.json$)
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]

  # ONEX Python Development Hooks (from shared templates)
  # Order: ruff format → ruff check → mypy (formatting before linting before type checking)
  # Note: ruff replaces both black and isort (10-100x faster)
  - repo: local
    hooks:
      - id: ruff-format
        name: ruff format (auto-format)
        entry: poetry run ruff format
        language: system
        types: [python]
        exclude: ^(tests/fixtures/validation/edge_cases/syntax_error\.py|\.github/workflows/|archived/).*$
        stages: [pre-commit]

      - id: ruff-fix
        name: ruff check (auto-fix linting + import sorting)
        entry: poetry run ruff check --fix --exit-non-zero-on-fix
        language: system
        types: [python]
        exclude: ^(tests/fixtures/validation/edge_cases/syntax_error\.py|\.github/workflows/|archived/).*$
        stages: [pre-commit]
        # Note: --exit-non-zero-on-fix ensures pre-commit fails if files were modified,
        # forcing you to re-stage the changes. This keeps pre-commit and CI in sync.

      - id: mypy-type-check
        name: mypy (type checking - strict)
        entry: bash -c 'poetry run mypy "$@" --show-error-codes --no-error-summary' --
        language: system
        types: [python]
        files: ^src/omnibase_core/.*\.py$
        exclude: ^(tests/|src/omnibase_core/examples|archive/|archived/).*\.py$
        pass_filenames: true  # Only check changed files, not entire codebase
        stages: [pre-push]  # Moved to pre-push: ~1-5s for changed files only

      # Cleanup: Clear tmp/ directory before commits
      # Prevents accumulation of temporary files from custom commands
      - id: clean-tmp-directory
        name: Clean tmp directory
        entry: bash -c "rm -rf tmp/* 2>/dev/null || true"
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

  # ONEX Framework Validation (from shared templates)
  - repo: local
    hooks:

      # ONEX Core Framework Validation (SHARED HOOKS)
      - id: validate-repository-structure
        name: ONEX Repository Structure Validation
        entry: poetry run python scripts/validation/validate_structure.py
        args: ['.', 'omnibase_core']
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

      - id: validate-naming-conventions
        name: ONEX Naming Convention Validation
        entry: poetry run python scripts/validation/validate_naming.py
        args: ['src/']
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        exclude: ^(tests/|archive/|archived/|scripts/validation/).*\.py$
        stages: [pre-push]  # Moved to pre-push: ~14s full codebase scan
        # Architectural exemptions documented in validate_naming.py ARCHITECTURAL_EXEMPTIONS

      - id: validate-file-locations
        name: ONEX File Location Enforcement
        entry: poetry run python scripts/validation/validate-file-locations.py
        language: system
        pass_filenames: false
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/).*\.py$
        stages: [pre-commit]

      - id: validate-no-duplicate-dirs
        name: ONEX Duplicate Directory Detection
        entry: poetry run python scripts/validation/validate-no-duplicate-dirs.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: validate-no-duplicate-models
        name: ONEX Duplicate Model Filename Prevention
        entry: poetry run python scripts/validation/validate-no-duplicate-models.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      - id: validate-no-empty-directories
        name: ONEX Empty Directory Prevention
        entry: poetry run python scripts/validation/validate-no-empty-directories.py
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # String Version Anti-Pattern Detection
      # Prevents use of ModelSemVer.parse("X.Y.Z") and direct version string literals
      # Enforces structured versions: ModelSemVer(1, 0, 0) instead of "1.0.0"
      # Catches: ModelSemVer.parse(), string literals, flat YAML versions
      # Allows: Docstrings, regex patterns (r"..."), test fixtures, log messages
      # See: docs/ANTI_PATTERNS.md#string-version-literals
      #
      # PROTOCOL EXCLUSION: protocols/ is excluded because Protocol types define
      # interfaces (structural typing), not concrete implementations. They may
      # reference version formats in docstrings/type hints for documentation.
      # See: scripts/validation/validate-union-usage.py module docstring for rationale.
      - id: validate-string-versions
        name: ONEX String Version Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-string-versions.py
        language: system
        pass_filenames: true
        files: ^.*\.(py|yaml|yml)$
        exclude: ^(tests/fixtures/validation/|archived/|archive/|src/omnibase_core/protocols/)
        stages: [pre-commit]

      - id: validate-archived-imports
        name: ONEX Archived Path Import Prevention
        entry: poetry run python scripts/validation/validate-archived-imports.py
        args: ['src/']
        language: system
        pass_filenames: false
        files: ^.*\.py$
        exclude: ^(archived/|archive/|tests/fixtures/validation/).*$
        stages: [pre-commit]

      - id: validate-no-backward-compatibility
        name: ONEX Backward Compatibility Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-no-backward-compatibility.py
        args: ['-d', 'src/']
        language: system
        pass_filenames: false
        files: ^.*\.py$
        exclude: ^(scripts/validation/validate-no-backward-compatibility\.py|archived/.*)$
        stages: [pre-commit]

      - id: validate-no-manual-yaml
        name: ONEX Manual YAML Prevention
        entry: poetry run python scripts/validation/validate-no-manual-yaml.py
        language: system
        pass_filenames: true
        files: ^.*\.py$
        exclude: ^(scripts/validation/validate-contracts\.py|scripts/validation/validate-string-versions\.py|scripts/validation/check_stub_implementations\.py|scripts/validation/validate-no-manual-yaml\.py|scripts/compute_contract_fingerprint\.py|scripts/lint_contract\.py|src/omnibase_core/utils/safe_yaml_loader\.py|src/omnibase_core/utils/util_safe_yaml_loader\.py|src/omnibase_core/validation/contracts\.py|src/omnibase_core/validation/contract_validator\.py|src/omnibase_core/discovery/mixin_discovery\.py|tests/fixtures/validation/)
        stages: [pre-commit]

      # AST-based validators - accept file arguments for fast pre-commit
      - id: validate-pydantic-patterns
        name: ONEX Pydantic Pattern Validation
        entry: poetry run python scripts/validation/validate-pydantic-patterns.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # UNION VALIDATION THRESHOLD:
      # Tech debt: Union type threshold reduced from 256 to 160 (OMN-676).
      # Target: Reduce to 0 incrementally. Tracking: OMN-468, OMN-676
      # Improvements: Created json_types.py with centralized aliases (JsonValue,
      # PrimitiveValue, ToolParameterValue), fixed any_contaminated and overly_broad patterns.
      - id: validate-union-usage
        name: ONEX Union Usage Validation
        entry: poetry run python scripts/validation/validate-union-usage.py
        args: ['--allow-invalid', '160']
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/|src/omnibase_core/protocols/).*\.py$
        stages: [pre-commit]

      # Repository-specific validation (omnibase_core only)
      - id: validate-contracts
        name: ONEX Contract Validation
        entry: poetry run python scripts/validation/validate-contracts.py
        language: system
        pass_filenames: false
        files: ^src/omnibase_core/(nodes|protocol|core).*\.py$
        stages: [pre-commit]

      - id: audit-optional-usage
        name: ONEX Optional Type Usage Audit
        entry: poetry run python scripts/validation/audit_optional.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: check-stub-implementations
        name: ONEX Stub Implementation Detector
        entry: poetry run python scripts/validation/check_stub_implementations.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|examples/prototypes/).*\.py$
        stages: [pre-commit]

      - id: check-no-fallbacks
        name: ONEX No Fallback Patterns Validation
        entry: poetry run python scripts/validation/check_no_fallbacks.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: check-error-raising
        name: ONEX Error Raising Validation
        entry: poetry run python scripts/validation/check_error_raising.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: validate-no-enhancement-prefixes
        name: ONEX Enhancement Prefix Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-no-enhancement-prefixes.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # PROTOCOL EXCLUSION: protocols/ is excluded because Protocol files define
      # multiple related interfaces in single files (e.g., ProtocolIdentifiable,
      # ProtocolNameable together). This is idiomatic for interface definitions.
      # See: scripts/validation/validate-union-usage.py module docstring for rationale.
      - id: onex-single-class-per-file
        name: ONEX Single Class Per File
        entry: poetry run python scripts/validation/validate-single-class-per-file.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        # Exclusions:
        # - protocols/: Protocol types define interfaces, not implementations
        # - util_singleton_holders.py: Singleton holder pattern requires multiple classes
        # - model_action_config_value.py: Action config value types
        # - model_node_config_value.py: Node config entry and schema types
        exclude: ^(tests/|archived/|archive/|scripts/validation/|src/omnibase_core/utils/util_singleton_holders\.py$|src/omnibase_core/models/core/model_action_config_value\.py$|src/omnibase_core/models/configuration/model_node_config_value\.py$|src/omnibase_core/protocols/)
        stages: [pre-commit]

      - id: validate-enum-model-imports
        name: ONEX Enum/Model Import Prevention
        entry: poetry run python scripts/validation/validate-enum-model-imports.py
        language: system
        pass_filenames: true
        files: ^src/omnibase_core/enums/.*\.py$
        exclude: ^(tests/|archived/|archive/).*\.py$
        stages: [pre-commit]

      - id: validate-typeddict-patterns
        name: ONEX TypedDict Pattern Validation
        entry: poetry run python scripts/validation/validate-typeddict-patterns.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # dict[str, Any] Anti-Pattern Detection
      # TECHNICAL DEBT: Current baseline is 842 violations (2025-12-05)
      # In file mode (pre-commit), any new violation fails
      # In directory mode (CI), compares against --max-violations threshold
      - id: validate-dict-any-usage
        name: ONEX dict[str, Any] Anti-Pattern Detection
        entry: poetry run python scripts/validation/validate-dict-any-usage.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: no-pydantic-bypass-in-prod
        name: ONEX Pydantic Bypass Prevention
        entry: poetry run python scripts/validation/validate-no-pydantic-bypass.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # Security: Secret Detection (prevents hardcoded secrets)
      - id: validate-secrets
        name: ONEX Secret Detection
        entry: poetry run python scripts/validation/validate-secrets.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # Security: Hardcoded Environment Variable Prevention
      - id: validate-hardcoded-env-vars
        name: ONEX Hardcoded Environment Variable Prevention
        entry: poetry run python scripts/validation/validate-hardcoded-env-vars.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      - id: validate-exception-handling
        name: ONEX Exception Handling Validation
        entry: poetry run python scripts/validation/validate-exception-handling.py
        language: system
        pass_filenames: true
        files: ^src/.*\.py$
        exclude: ^(tests/|archived/|archive/|scripts/validation/).*\.py$
        stages: [pre-commit]

      # ONEX Model-Primitive Union Prevention (PR#59 follow-up)
      # Prevents Union types mixing models and primitives that cause Pydantic
      # validation race conditions in parallel execution (pytest-xdist)
      - id: validate-no-model-primitive-unions
        name: ONEX Model-Primitive Union Prevention
        entry: ./scripts/validate-no-model-primitive-unions.sh
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-commit]

      # Documentation link validation - prevents broken links in CI
      - id: validate-doc-links
        name: ONEX Documentation Link Validation
        entry: poetry run python scripts/validation/validate-doc-links.py
        args: [--fix-case]
        language: system
        pass_filenames: false
        always_run: true
        stages: [pre-push]  # Moved to pre-push: scans all markdown files

      # NOTE: Smoke tests removed (2025-12) - redundant with CI
      # CI runs full 12k+ test suite with 20 parallel splits
      # Removing saves ~4-5 minutes per push with no coverage loss

      # Protocol @runtime_checkable Validation
      # Ensures all Protocol classes have @runtime_checkable decorator
      # Required for isinstance() checks and duck typing at runtime
      - id: check-protocol-runtime-checkable
        name: ONEX Protocol @runtime_checkable Validation
        entry: poetry run python scripts/validation/check_protocol_runtime_checkable.py
        language: system
        pass_filenames: false
        always_run: true
        files: ^src/omnibase_core/protocols/.*\.py$
        stages: [pre-commit]

      # Protocol __all__ Exports Validation
      # Validates that protocol files have correct __all__ exports matching
      # their Protocol class definitions
      - id: check-protocol-exports
        name: ONEX Protocol __all__ Exports Validation
        entry: poetry run python scripts/check_protocol_exports.py
        language: system
        pass_filenames: false
        always_run: true
        files: ^src/omnibase_core/protocols/.*\.py$
        stages: [pre-commit]

      # Protocol UUID Enforcement (pre-push only)
      # Verifies protocol type annotations use UUID instead of str
      # Catches issues like / before CI
      # ~6s runtime - acceptable for pre-push but too slow for every commit
      - id: pytest-protocol-uuid-enforcement
        name: Protocol UUID Enforcement Check
        entry: poetry run pytest
        language: system
        pass_filenames: false
        always_run: true
        args:
          - tests/unit/protocols/test_protocol_uuid_enforcement.py
          - --maxfail=3
          - -x
          - --tb=short
          - -q
          - --timeout=30
          - -p
          - no:rerunfailures
        stages: [pre-push]

# Configuration
default_install_hook_types: [pre-commit, pre-push]
default_stages: [pre-commit]
fail_fast: false
# Note: minimum_pre_commit_version removed to avoid string version anti-pattern
# Project requires pre-commit >= 2.15.0 (document in README if needed)

# Performance optimization: Enable parallel execution
# This significantly reduces total execution time
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes for omnibase_core

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_schedule: weekly
  submodules: false
