# SPDX-FileCopyrightText: 2025 OmniNode.ai Inc.
# SPDX-License-Identifier: MIT
---
node_type: REDUCER_GENERIC
contract_version: {major: 1, minor: 1, patch: 0}
# Fingerprint: SHA-256 hash of canonical normalized contract content (excluding fingerprint field).
# Normalization includes: sorted keys, consistent spacing, excluded fields (fingerprint, metadata).
# Full specification: docs/architecture/CONTRACT_STABILITY_SPEC.md
fingerprint: "1.1.0:adb6c8f6d107"
state_transitions:
  version: {major: 1, minor: 1, patch: 0}
  state_machine_version: {major: 1, minor: 0, patch: 0}
  state_machine_name: metrics_aggregation_fsm
  description: Aggregates metrics from multiple data sources with validation
  initial_state: idle
  states:
    - state_name: idle
      description: Initial state - waiting for collection trigger
      entry_actions: []
      exit_actions: []
      is_terminal: false
      metadata:
        ui_color: '#9CA3AF'
        icon: pause
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: collecting
      description: Collecting metrics from configured data sources
      entry_actions:
        - start_collection_timer
        - initialize_metric_buffers
      exit_actions:
        - stop_collection_timer
        - flush_metric_buffers
      is_terminal: false
      metadata:
        ui_color: '#3B82F6'
        icon: download
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: validating
      description: Validating collected metrics for completeness
      entry_actions:
        - start_validation
      exit_actions:
        - log_validation_results
      is_terminal: false
      metadata:
        ui_color: '#FBBF24'
        icon: check-circle
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: aggregating
      description: Computing aggregate statistics from validated metrics
      entry_actions:
        - begin_aggregation
        - allocate_aggregation_buffers
      exit_actions:
        - finalize_aggregation
        - release_aggregation_buffers
      is_terminal: false
      metadata:
        ui_color: '#8B5CF6'
        icon: calculator
      version: {major: 1, minor: 0, patch: 0}
      state_type: operational
    - state_name: completed
      description: Metrics aggregation completed successfully
      entry_actions:
        - emit_completion_event
        - cleanup_resources
      exit_actions: []
      is_terminal: true
      metadata:
        ui_color: '#10B981'
        icon: check
      version: {major: 1, minor: 0, patch: 0}
      state_type: terminal
    - state_name: failed
      description: Metrics aggregation failed
      entry_actions:
        - emit_failure_event
        - rollback_partial_aggregation
        - cleanup_resources
      exit_actions: []
      is_terminal: true
      metadata:
        ui_color: '#EF4444'
        icon: x-circle
      version: {major: 1, minor: 0, patch: 0}
      state_type: terminal
  transitions:
    - transition_name: start_collection
      from_state: idle
      to_state: collecting
      trigger: collect_metrics
      description: Begin collecting metrics from data sources
      conditions:
        - condition_name: has_data_sources
          expression: data_sources min_length 1
          required: true
          description: At least one data source must be configured
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: emit_collection_started
          action_type: event
          is_critical: false
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: complete_collection
      from_state: collecting
      to_state: validating
      trigger: collection_complete
      description: All metrics collected, begin validation
      conditions:
        - condition_name: minimum_data_collected
          expression: collected_metrics min_length 10
          required: true
          description: At least 10 metrics must be collected
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: snapshot_collected_metrics
          action_type: data_capture
          is_critical: true
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: validation_passed
      from_state: validating
      to_state: aggregating
      trigger: validation_success
      description: Metrics validated, begin aggregation
      conditions: []
      actions:
        - action_name: mark_metrics_validated
          action_type: data_capture
          is_critical: false
          timeout_ms: 500
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: validation_failed_retry
      from_state: validating
      to_state: collecting
      trigger: validation_failed
      description: Validation failed, retry collection
      conditions:
        - condition_name: retries_remaining
          expression: retry_count less_than 3
          required: true
          description: Maximum 3 retries allowed
          version: {major: 1, minor: 0, patch: 0}
          condition_type: data_validation
      actions:
        - action_name: increment_retry_counter
          action_type: data_capture
          is_critical: true
          timeout_ms: 100
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: aggregation_complete
      from_state: aggregating
      to_state: completed
      trigger: aggregation_success
      description: Aggregation completed successfully
      conditions: []
      actions:
        - action_name: persist_final_results
          action_type: persistence
          is_critical: true
          timeout_ms: 5000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emit_metrics_to_monitoring
          action_type: event
          is_critical: false
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: handle_error
      from_state: '*'
      to_state: failed
      trigger: error_occurred
      description: Handle errors from any state
      conditions: []
      actions:
        - action_name: log_error_details
          action_type: logging
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
        - action_name: emit_error_alert
          action_type: alert
          is_critical: false
          timeout_ms: 2000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
    - transition_name: handle_timeout
      from_state: '*'
      to_state: failed
      trigger: timeout
      description: Handle timeouts from any non-terminal state
      conditions: []
      actions:
        - action_name: log_timeout_event
          action_type: logging
          is_critical: true
          timeout_ms: 1000
          version: {major: 1, minor: 0, patch: 0}
      version: {major: 1, minor: 0, patch: 0}
  terminal_states:
    - completed
    - failed
  error_states:
    - failed
  persistence_enabled: true
  recovery_enabled: true
  operations:
    - operation_name: reset_aggregation
      description: Reset FSM to idle state for new aggregation cycle
      trigger: reset
      target_state: idle
      requires_permission: true
      is_destructive: true
      rollback_transitions:
        - transition_name: rollback_reset
          from_state: idle
          to_state: collecting
          trigger: undo_reset
      version: {major: 1, minor: 0, patch: 0}
      operation_type: administrative
metadata:
  version: {major: 1, minor: 1, patch: 0}
  author: ONEX Framework Team
  description: Declarative metrics aggregation reducer using FSM pattern
  tags:
    - reducer
    - fsm
    - declarative
    - metrics
  documentation_url: https://docs.onex.ai/reducers/metrics-aggregator
