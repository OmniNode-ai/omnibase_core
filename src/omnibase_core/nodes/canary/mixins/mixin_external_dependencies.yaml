# ONEX Mixin: External Dependencies
# Provides standardized external service integrations for EFFECT nodes only

mixin_name: "mixin_external_dependencies"
mixin_version: {major: 1, minor: 0, patch: 0}
description: "External service integrations, API calls, and I/O operations for EFFECT nodes"
applicable_node_types: ["EFFECT"]  # EFFECT only - architectural constraint

# === EXTERNAL DEPENDENCY ACTIONS ===
actions:
  - name: "execute_external_call"
    description: "Execute call to external service or API"
    inputs: ["service_config", "call_parameters", "retry_config"]
    outputs: ["call_result", "execution_metadata"]
    required: true
    timeout_ms: 30000

  - name: "validate_external_response"
    description: "Validate response from external service"
    inputs: ["response_data", "validation_schema", "service_contract"]
    outputs: ["validation_result", "normalized_response"]
    required: true
    timeout_ms: 2000

  - name: "manage_service_health"
    description: "Monitor and manage health of external dependencies"
    inputs: ["service_list", "health_check_config"]
    outputs: ["health_status", "availability_metrics"]
    required: false
    timeout_ms: 10000

  - name: "handle_service_failure"
    description: "Handle failures from external services with fallback strategies"
    inputs: ["failure_context", "fallback_config", "recovery_options"]
    outputs: ["recovery_action", "fallback_result"]
    required: true
    timeout_ms: 5000

  - name: "transform_external_data"
    description: "Transform data between internal and external formats"
    inputs: ["source_data", "transformation_config", "target_schema"]
    outputs: ["transformed_data", "transformation_metadata"]
    required: false
    timeout_ms: 3000

# === EXTERNAL DEPENDENCY CONFIGURATION ===
external_dependency_config:
  connection_pool_size: 20
  default_timeout_ms: 15000
  max_concurrent_calls: 50
  circuit_breaker_enabled: true
  retry_policy:
    max_retries: 3
    initial_delay_ms: 1000
    max_delay_ms: 10000
    exponential_backoff: true
    jitter_enabled: true
  rate_limiting:
    enabled: true
    requests_per_second: 100
    burst_capacity: 200
    
# === SERVICE TYPES ===
supported_service_types:
  rest_api:
    protocol: "HTTP/HTTPS"
    authentication: ["bearer_token", "api_key", "oauth2", "basic_auth"]
    serialization: ["json", "xml", "form_data"]
    compression: ["gzip", "deflate"]
    
  database:
    protocols: ["postgresql", "mysql", "mongodb", "cassandra"]
    connection_pooling: true
    transaction_support: true
    streaming_support: false
    
  message_queue:
    protocols: ["kafka", "rabbitmq", "aws_sqs", "azure_service_bus"]
    delivery_guarantee: ["at_least_once", "at_most_once", "exactly_once"]
    batching_support: true
    
  file_storage:
    protocols: ["s3", "azure_blob", "gcs", "sftp", "local"]
    streaming_support: true
    encryption_support: true
    versioning_support: true
    
  external_apis:
    protocols: ["rest", "graphql", "grpc", "soap"]
    authentication_flows: ["oauth2", "api_key", "jwt", "custom"]
    rate_limiting_aware: true

# === CIRCUIT BREAKER PATTERNS ===
circuit_breaker_config:
  failure_threshold: 10
  timeout_duration_ms: 60000  # 1 minute
  half_open_max_calls: 3
  metrics_window_ms: 10000    # 10 seconds
  min_calls_for_evaluation: 5
  
# === FALLBACK STRATEGIES ===
fallback_strategies:
  cached_response:
    enabled: true
    cache_ttl_ms: 300000  # 5 minutes
    stale_while_revalidate: true
    
  default_response:
    enabled: true
    response_templates: {}
    static_fallbacks: {}
    
  alternative_service:
    enabled: false
    service_priority_list: []
    automatic_failover: true
    
  graceful_degradation:
    enabled: true
    reduced_functionality_mode: true
    user_notification_required: true

# === OUTPUT MODELS ===
output_models:
  call_result:
    success: "boolean"
    response_data: "object"
    http_status: "integer"
    response_time_ms: "integer"
    service_endpoint: "string"
    headers:
      type: "object"
      additionalProperties: "string"
    metadata:
      retry_count: "integer"
      circuit_breaker_state: "enum[CLOSED,OPEN,HALF_OPEN]"
      
  execution_metadata:
    service_name: "string"
    operation_name: "string"
    start_time: "datetime"
    end_time: "datetime"
    total_time_ms: "integer"
    network_time_ms: "integer"
    processing_time_ms: "integer"
    bytes_sent: "integer"
    bytes_received: "integer"
    
  health_status:
    service_name: "string"
    status: "enum[HEALTHY,DEGRADED,UNHEALTHY,UNKNOWN]"
    last_check: "datetime"
    response_time_ms: "integer"
    error_rate_percent: "float"
    availability_percent: "float"
    circuit_breaker_state: "string"
    
  fallback_result:
    fallback_strategy_used: "string"
    fallback_success: "boolean"
    fallback_data: "object"
    original_error: "string"
    degradation_level: "enum[NONE,PARTIAL,FULL]"

# === AUTHENTICATION PATTERNS ===
authentication_patterns:
  oauth2:
    grant_types: ["client_credentials", "authorization_code"]
    token_refresh_enabled: true
    scope_management: true
    
  api_key:
    key_rotation_supported: true
    header_based: true
    query_param_based: false
    
  jwt_bearer:
    token_validation: true
    claim_extraction: true
    expiration_handling: true

# === DATA TRANSFORMATION PATTERNS ===
data_transformation:
  input_formats: ["json", "xml", "csv", "protobuf", "avro"]
  output_formats: ["json", "xml", "csv", "protobuf", "avro"]
  transformation_types:
    - "field_mapping"
    - "data_type_conversion" 
    - "structure_flattening"
    - "data_enrichment"
    - "validation_and_sanitization"

# === DEPENDENCIES PROVIDED ===
dependencies:
  - name: "external_integration"
    type: "capability"
    description: "Provides external service integration capabilities"
    
  - name: "api_client"
    type: "capability"
    description: "Provides HTTP/REST API client capabilities"
    
  - name: "data_transformation"
    type: "capability"
    description: "Provides data transformation and mapping capabilities"

# === DEPENDENCIES REQUIRED ===
requires_dependencies:
  - name: "protocol_http_client"
    type: "protocol"
    description: "HTTP client protocol for REST API calls"
    
  - name: "protocol_database_client"
    type: "protocol"
    description: "Database client protocol for database operations"
    optional: true
    
  - name: "protocol_message_queue_client"
    type: "protocol"
    description: "Message queue client protocol"
    optional: true

# === METRICS ===
metrics:
  - name: "external_calls_total"
    type: "counter"
    description: "Total number of external service calls"
    labels: ["service_name", "operation", "status"]
    
  - name: "external_call_duration"
    type: "histogram"
    description: "Duration of external service calls"
    labels: ["service_name", "operation"]
    buckets: [50, 100, 500, 1000, 5000, 10000, 30000]
    
  - name: "circuit_breaker_state_changes"
    type: "counter"
    description: "Number of circuit breaker state changes"
    labels: ["service_name", "from_state", "to_state"]
    
  - name: "fallback_activations"
    type: "counter"
    description: "Number of fallback strategy activations"
    labels: ["service_name", "fallback_strategy"]
    
  - name: "external_service_availability"
    type: "gauge"
    description: "External service availability percentage"
    labels: ["service_name"]
    
  - name: "data_transformation_operations"
    type: "counter"
    description: "Number of data transformation operations"
    labels: ["source_format", "target_format", "transformation_type"]
    
  - name: "authentication_operations"
    type: "counter"
    description: "Number of authentication operations"
    labels: ["service_name", "auth_type", "success"]