# ONEX Mixin: Workflow Coordination
# Provides standardized workflow orchestration patterns for ORCHESTRATOR nodes only

mixin_name: "mixin_workflow_coordination"
mixin_version: {major: 1, minor: 0, patch: 0}
description: "Workflow orchestration, task coordination, and execution management for ORCHESTRATOR nodes"
applicable_node_types: ["ORCHESTRATOR"]  # ORCHESTRATOR only - architectural constraint

# === WORKFLOW COORDINATION ACTIONS ===
actions:
  - name: "create_workflow"
    description: "Create a new workflow execution instance"
    inputs: ["workflow_definition", "input_parameters", "execution_config"]
    outputs: ["workflow_instance", "execution_id"]
    required: true
    timeout_ms: 5000

  - name: "execute_workflow"
    description: "Execute workflow with coordinated node interactions"
    inputs: ["workflow_instance", "execution_context"]
    outputs: ["execution_result", "coordination_metrics"]
    required: true
    timeout_ms: 300000  # 5 minutes max

  - name: "coordinate_nodes"
    description: "Coordinate execution across COMPUTE, EFFECT, and REDUCER nodes"
    inputs: ["coordination_plan", "node_assignments", "sync_requirements"]
    outputs: ["coordination_result", "node_statuses"]
    required: true
    timeout_ms: 60000

  - name: "monitor_workflow_progress"
    description: "Monitor and track workflow execution progress"
    inputs: ["workflow_id", "monitoring_config"]
    outputs: ["progress_status", "performance_metrics"]
    required: false
    timeout_ms: 2000

  - name: "handle_workflow_failure"
    description: "Handle workflow failures with recovery strategies"
    inputs: ["failure_context", "recovery_config", "rollback_options"]
    outputs: ["recovery_action", "workflow_status"]
    required: true
    timeout_ms: 10000

# === WORKFLOW COORDINATION CONFIGURATION ===
workflow_coordination_config:
  max_concurrent_workflows: 10
  default_workflow_timeout_ms: 600000  # 10 minutes
  node_coordination_timeout_ms: 30000  # 30 seconds
  checkpoint_interval_ms: 60000       # 1 minute
  auto_retry_enabled: true
  parallel_execution_enabled: true
  workflow_persistence_enabled: true
  
# === WORKFLOW EXECUTION PATTERNS ===
execution_patterns:
  sequential:
    description: "Execute nodes in sequence: COMPUTE → EFFECT → REDUCER"
    parallelism: false
    fault_tolerance: "stop_on_error"
    coordination_overhead: "low"
    
  parallel_compute:
    description: "Parallel COMPUTE execution with synchronized aggregation"
    parallelism: true
    max_parallel_compute: 5
    synchronization_points: ["after_compute", "before_reducer"]
    
  pipeline:
    description: "Streaming pipeline with overlapped execution"
    parallelism: true
    buffering_enabled: true
    backpressure_handling: true
    
  scatter_gather:
    description: "Scatter work to multiple nodes, gather results"
    parallelism: true
    scatter_strategy: "round_robin"
    gather_timeout_ms: 30000

# === NODE COORDINATION PATTERNS ===
node_coordination:
  COMPUTE_coordination:
    assignment_strategy: "load_balanced"
    result_aggregation: "collect_all"
    failure_handling: "retry_individual"
    timeout_handling: "extend_deadline"
    
  EFFECT_coordination:
    assignment_strategy: "capability_matched"
    side_effect_management: "coordinated"
    failure_handling: "compensating_action"
    timeout_handling: "graceful_timeout"
    
  REDUCER_coordination:
    assignment_strategy: "state_affinity"
    aggregation_strategy: "incremental"
    failure_handling: "state_rollback"
    consistency_requirements: "strong"

# === OUTPUT MODELS ===
output_models:
  workflow_instance:
    workflow_id: "string"
    workflow_name: "string"
    workflow_version: "string"
    created_timestamp: "datetime"
    status: "enum[CREATED,RUNNING,COMPLETED,FAILED,CANCELLED]"
    input_parameters: "object"
    execution_context: "object"
    
  coordination_result:
    coordination_id: "string"
    workflow_id: "string"
    nodes_coordinated:
      type: "array"
      items:
        node_id: "string"
        node_type: "enum[COMPUTE,EFFECT,REDUCER]"
        assignment_status: "enum[ASSIGNED,EXECUTING,COMPLETED,FAILED]"
        execution_time_ms: "integer"
        resource_usage: "object"
    coordination_overhead_ms: "integer"
    synchronization_points:
      type: "array"
      items:
        point_name: "string"
        timestamp: "datetime"
        nodes_synchronized: "integer"
        
  progress_status:
    workflow_id: "string"
    overall_progress_percent: "float"
    current_stage: "string"
    stages_completed: "integer"
    stages_total: "integer"
    estimated_completion: "datetime"
    node_progress:
      type: "array"
      items:
        node_id: "string"
        node_type: "string"
        progress_percent: "float"
        status: "string"
        
  workflow_metrics:
    total_execution_time_ms: "integer"
    coordination_overhead_ms: "integer"
    node_utilization_percent: "float"
    parallelism_achieved: "float"
    synchronization_delays_ms: "integer"
    resource_efficiency_score: "float"

# === WORKFLOW DEFINITION SCHEMA ===
workflow_definition_schema:
  workflow_metadata:
    name: "string"
    version: "string"
    description: "string"
    timeout_ms: "integer"
    
  execution_graph:
    nodes:
      type: "array"
      items:
        node_id: "string"
        node_type: "enum[COMPUTE,EFFECT,REDUCER]"
        node_requirements: "object"
        dependencies:
          type: "array"
          items: "string"  # node_ids
          
  coordination_rules:
    synchronization_points:
      type: "array"
      items: "string"
    parallel_execution_allowed: "boolean"
    failure_recovery_strategy: "enum[RETRY,ROLLBACK,COMPENSATE,ABORT]"

# === FAILURE RECOVERY STRATEGIES ===
failure_recovery:
  retry_strategy:
    max_retries: 3
    retry_delay_ms: 2000
    exponential_backoff: true
    retry_on_failures: ["TIMEOUT", "NETWORK_ERROR", "TRANSIENT_ERROR"]
    
  rollback_strategy:
    enabled: true
    checkpoint_based: true
    compensation_actions_enabled: true
    partial_rollback_supported: true
    
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    timeout_ms: 60000
    half_open_retry_count: 2

# === WORKFLOW PERSISTENCE ===
workflow_persistence:
  checkpoint_strategy: "time_based"
  checkpoint_interval_ms: 60000
  state_compression: true
  incremental_checkpoints: true
  recovery_point_objective_ms: 30000  # 30 seconds max data loss

# === DEPENDENCIES PROVIDED ===
dependencies:
  - name: "workflow_orchestration"
    type: "capability"
    description: "Provides workflow orchestration and execution capabilities"
    
  - name: "node_coordination"
    type: "capability"
    description: "Provides multi-node coordination and synchronization"
    
  - name: "execution_management"
    type: "capability"
    description: "Provides workflow execution monitoring and management"

# === DEPENDENCIES REQUIRED ===
requires_dependencies:
  - name: "protocol_event_bus"
    type: "protocol"
    description: "Event bus for node coordination and communication"
    
  - name: "protocol_service_registry"
    type: "protocol"
    description: "Service registry for node discovery and assignment"
    
  - name: "protocol_persistence"
    type: "protocol"
    description: "Persistence layer for workflow state and checkpoints"
    optional: true

# === METRICS ===
metrics:
  - name: "workflows_created"
    type: "counter"
    description: "Total number of workflows created"
    labels: ["workflow_type", "workflow_version"]
    
  - name: "workflows_executed"
    type: "counter"
    description: "Total number of workflows executed"
    labels: ["workflow_type", "status", "execution_pattern"]
    
  - name: "workflow_execution_time"
    type: "histogram"
    description: "Total workflow execution time"
    labels: ["workflow_type", "execution_pattern"]
    buckets: [1000, 5000, 15000, 60000, 300000, 600000]
    
  - name: "node_coordination_time"
    type: "histogram"
    description: "Time spent on node coordination"
    labels: ["node_type", "coordination_type"]
    
  - name: "active_workflows"
    type: "gauge"
    description: "Number of currently active workflows"
    
  - name: "coordination_failures"
    type: "counter"
    description: "Number of coordination failures"
    labels: ["failure_type", "node_type", "recovery_action"]
    
  - name: "parallelism_utilization"
    type: "histogram"
    description: "Achieved parallelism as percentage of potential"
    labels: ["workflow_type"]
    
  - name: "synchronization_delays"
    type: "histogram"
    description: "Delays caused by synchronization points"
    labels: ["synchronization_type"]