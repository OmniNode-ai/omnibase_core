# Handoff: OMN-1010, OMN-1016, OMN-1020 Parallel Tasks

**Branch**: `feature/omn-1010-1016-1020-parallel-tasks`
**Created**: 2025-12-25
**Status**: In Progress
**Repository**: omnibase_core

---

## 1. Overview

Three parallel tasks for omnibase_core improvements:

| Issue | Title | Complexity | Dependencies |
|-------|-------|------------|--------------|
| OMN-1016 | Split ProtocolEventBus (ISP) | Medium | None |
| OMN-1020 | Full SemVer 2.0.0 Support | Medium | None |
| OMN-1010 | Type Factory Method Variables | Low | None |

All tasks are **independent** and can be worked on in parallel. Each should be validated independently before combining commits.

---

## 2. Task Details

### OMN-1016: Split ProtocolEventBus into Publisher/Subscriber/Lifecycle Protocols (ISP)

**Goal**: Refactor the event bus protocol hierarchy to follow the Interface Segregation Principle (ISP). Components that only need to publish events should not depend on the full `ProtocolEventBus` with subscribe/lifecycle capabilities.

**Location**: `src/omnibase_core/protocols/event_bus/`

**Background**:
- Currently `omnibase_infra` has a `ProtocolEventBusLike` protocol in `mixins/` that provides a minimal publish interface
- This has a confusing name (`Like` suffix) and lives in the wrong location
- Should be part of a proper protocol hierarchy in `omnibase_core`

**New Files to Create**:

```
src/omnibase_core/protocols/event_bus/
├── protocol_event_bus_publisher.py    # NEW
├── protocol_event_bus_subscriber.py   # NEW
├── protocol_event_bus_lifecycle.py    # NEW
├── protocol_event_bus.py              # UPDATED - inherits from all three
└── __init__.py                        # UPDATED - export new protocols
```

**Protocol Definitions**:

```python
# protocol_event_bus_publisher.py
@runtime_checkable
class ProtocolEventBusPublisher(Protocol):
    """Minimal protocol for components that only need to publish events."""

    async def publish(
        self,
        topic: str,
        key: bytes | None,
        value: bytes,
        headers: ProtocolEventBusHeaders | None = None,
    ) -> None: ...

    async def publish_envelope(
        self,
        envelope: object,
        topic: str,
    ) -> None: ...


# protocol_event_bus_subscriber.py
@runtime_checkable
class ProtocolEventBusSubscriber(Protocol):
    """Minimal protocol for components that only need to subscribe."""

    async def subscribe(
        self,
        topic: str,
        group_id: str,
        on_message: Callable[[ProtocolEventMessage], Awaitable[None]],
    ) -> Callable[[], Awaitable[None]]: ...

    async def start_consuming(self) -> None: ...


# protocol_event_bus_lifecycle.py
@runtime_checkable
class ProtocolEventBusLifecycle(Protocol):
    """Protocol for event bus lifecycle management."""

    async def start(self) -> None: ...
    async def shutdown(self) -> None: ...
    async def close(self) -> None: ...
    async def health_check(self) -> dict[str, object]: ...


# protocol_event_bus.py (updated)
@runtime_checkable
class ProtocolEventBus(
    ProtocolEventBusPublisher,
    ProtocolEventBusSubscriber,
    ProtocolEventBusLifecycle,
    Protocol
):
    """Full ONEX event bus protocol - combines all capabilities."""

    @property
    def adapter(self) -> ProtocolKafkaEventBusAdapter: ...

    @property
    def environment(self) -> str: ...

    @property
    def group(self) -> str: ...

    async def broadcast_to_environment(...) -> None: ...
    async def send_to_group(...) -> None: ...
```

**Key Requirements**:
- All protocols must be `@runtime_checkable`
- `ProtocolEventBus` inherits from all three new protocols
- Must be backwards compatible
- Add comprehensive docstrings with usage examples
- Export all new protocols from `__init__.py`

**Acceptance Criteria**:
- [ ] Create `ProtocolEventBusPublisher` in `omnibase_core/protocols/event_bus/`
- [ ] Create `ProtocolEventBusSubscriber` in `omnibase_core/protocols/event_bus/`
- [ ] Create `ProtocolEventBusLifecycle` in `omnibase_core/protocols/event_bus/`
- [ ] Update `ProtocolEventBus` to inherit from all three
- [ ] Export all new protocols from `__init__.py`
- [ ] Add comprehensive docstrings with usage examples
- [ ] All protocols are `@runtime_checkable`

**Validation**:
```bash
poetry run mypy src/omnibase_core/protocols/event_bus/
poetry run pytest tests/unit/protocols/ -x
```

---

### OMN-1020: Full SemVer 2.0.0 Support in ModelSemVer

**Goal**: Extend `ModelSemVer` to support full SemVer 2.0.0 specification including prerelease and build metadata. The current implementation is a simplified version that hardcodes `is_prerelease() = False`.

**Location**: `src/omnibase_core/models/primitives/model_semver.py`

**Problem**:
- Current `ModelSemVer` is intentionally simplified
- No prerelease support
- No build metadata
- `is_prerelease()` hardcoded to `False`
- This caused `omnibase_infra` to create a parallel implementation with full support, leading to type drift

**Changes Needed**:

1. **Add New Fields**:
```python
major: int
minor: int
patch: int
prerelease: tuple[str | int, ...] | None  # dot-separated identifiers
build: tuple[str, ...] | None  # preserved for identity, ignored for precedence
```

2. **Implement `parse()` Classmethod**:
```python
@classmethod
def parse(cls, version_str: str) -> ModelSemVer:
    """Parse MAJOR.MINOR.PATCH[-prerelease][+build]"""
```

3. **Fix `is_prerelease()`**: Replace stub with real implementation

4. **Implement Comparison Per SemVer Spec**:
   - Compare major, minor, patch
   - prerelease < no prerelease
   - prerelease identifiers compared per spec
   - build metadata **ignored** for precedence

5. **Add Helper Methods**:
   - `precedence_key()` - for ordering (ignores build)
   - `exact_key()` - for identity (includes build)

6. **Serialization**:
```python
def __str__(self) -> str:
    # Returns: MAJOR.MINOR.PATCH[-prerelease][+build]
```

**Acceptance Criteria**:
- [ ] Add `prerelease` and `build` fields to ModelSemVer
- [ ] Replace `is_prerelease()` stub with real implementation
- [ ] Implement full SemVer parsing and validation in `parse()`
- [ ] Implement correct comparison semantics (`__lt__`, `__le__`, etc.)
- [ ] Add `precedence_key()` and `exact_key()` methods
- [ ] Update JSON schema for serialization
- [ ] Add comprehensive unit tests:
  - [ ] Prerelease ordering matrix
  - [ ] Build metadata ignored for precedence
  - [ ] Invalid SemVer rejection (leading zeros, etc.)
- [ ] Remove/update "simplified version" comments

**Validation**:
```bash
poetry run pytest tests/unit/models/primitives/test_model_semver.py -xvs
poetry run mypy src/omnibase_core/models/primitives/model_semver.py
```

---

### OMN-1010: Type Factory Method Intermediate Variables

**Goal**: Replace `dict[str, Any]` local variables in factory methods with proper typed models.

**Location**: `src/omnibase_core/models/services/model_node_service_config.py`

**Problem**: Factory methods lose type safety during construction by using intermediate `dict[str, Any]` variables.

**Variables to Type** (5 total):

| Line | Variable | Should Be |
|------|----------|-----------|
| 206 | `event_bus_config` | `ModelEventBusConfig` |
| 215 | `network_config` | `ModelNetworkConfig` |
| 220 | `health_config` | `ModelHealthConfig` |
| 225 | `monitoring_config` | `ModelMonitoringConfig` |
| 235 | `security_config` | `ModelSecurityConfig` |

**Before**:
```python
def create_config(self) -> ModelNodeServiceConfig:
    event_bus_config: dict[str, Any] = {...}
    return ModelNodeServiceConfig(event_bus=ModelEventBusConfig(**event_bus_config))
```

**After**:
```python
def create_config(self) -> ModelNodeServiceConfig:
    event_bus_config = ModelEventBusConfig(...)
    return ModelNodeServiceConfig(event_bus=event_bus_config)
```

**Acceptance Criteria**:
- [ ] All 5 local variables use proper model types
- [ ] Factory methods construct models directly
- [ ] No intermediate `dict[str, Any]` usage
- [ ] Type checking passes
- [ ] Tests pass

**Validation**:
```bash
poetry run mypy src/omnibase_core/models/services/model_node_service_config.py
poetry run pytest tests/unit/models/services/ -x
```

---

## 3. Execution Order

All 3 tasks are **completely independent** and can be worked on in parallel:

```
   OMN-1016 (protocols) ──────────┐
                                  │
   OMN-1020 (semver) ─────────────┼──> Merge to branch
                                  │
   OMN-1010 (factory typing) ─────┘
```

**Recommended approach**:
1. Each task should be validated independently
2. Commit each task separately with clear commit messages
3. Run full validation after all tasks are complete

---

## 4. Validation Commands

### Full Validation (After All Tasks)

```bash
# Type checking (strict mode - 0 errors required)
poetry run mypy src/omnibase_core/ --strict

# All unit tests
poetry run pytest tests/unit/ -x --timeout=60

# Full test suite with coverage
poetry run pytest tests/ --cov=src/omnibase_core --cov-fail-under=60
```

### Per-Task Validation

#### OMN-1016 (Protocol Split)
```bash
poetry run mypy src/omnibase_core/protocols/event_bus/
poetry run pytest tests/unit/protocols/ -x
```

#### OMN-1020 (SemVer)
```bash
poetry run mypy src/omnibase_core/models/primitives/model_semver.py
poetry run pytest tests/unit/models/primitives/test_model_semver.py -xvs
```

#### OMN-1010 (Factory Typing)
```bash
poetry run mypy src/omnibase_core/models/services/model_node_service_config.py
poetry run pytest tests/unit/models/services/ -x
```

---

## 5. Success Criteria

### OMN-1016: Protocol Split
- [ ] 3 new protocols created (`Publisher`, `Subscriber`, `Lifecycle`)
- [ ] `ProtocolEventBus` updated to inherit from all three
- [ ] All protocols are `@runtime_checkable`
- [ ] Exports added to `__init__.py`
- [ ] Backwards compatible (existing code still works)

### OMN-1020: SemVer Support
- [ ] `prerelease` and `build` fields added
- [ ] `parse()` classmethod implemented
- [ ] `is_prerelease()` returns real value
- [ ] Comparison operators follow SemVer spec
- [ ] Comprehensive tests for edge cases

### OMN-1010: Factory Typing
- [ ] All 5 factory variables properly typed
- [ ] No `dict[str, Any]` intermediate variables
- [ ] Direct model construction

### Overall
- [ ] All mypy checks pass (0 errors)
- [ ] All tests pass
- [ ] Coverage >= 60%

---

## 6. Linear Links

| Issue | URL | Status |
|-------|-----|--------|
| OMN-1016 | https://linear.app/omninode/issue/OMN-1016 | Backlog |
| OMN-1020 | https://linear.app/omninode/issue/OMN-1020 | Backlog |
| OMN-1010 | https://linear.app/omninode/issue/OMN-1010 | Backlog |

**Project**: MVP - OmniNode Platform Foundation
**Team**: Omninode

---

## 7. Notes and Context

### OMN-1016 Follow-up Work
After this ticket is complete, a follow-up ticket should:
- Update `omnibase_infra` to import `ProtocolEventBusPublisher` from `omnibase_core`
- Remove `ProtocolEventBusLike` from `omnibase_infra/mixins/`
- Update `TimeoutEmitter` and other consumers

### OMN-1020 Non-Goals
- No policy enforcement in ModelSemVer (belongs in validators)
- No new versioning scheme
- No breaking changes to existing `major`, `minor`, `patch` fields

### OMN-1010 Impact
- **Breaking Change**: No - internal implementation change
- **Files Affected**: 1 file
- **Complexity**: Low - straightforward refactor

---

## 8. Resumption Checklist

When resuming work on this branch:

1. [ ] Checkout the branch: `git checkout feature/omn-1010-1016-1020-parallel-tasks`
2. [ ] Check current status: `git status`
3. [ ] Review any partial work in the files mentioned above
4. [ ] Run validation to see current state: `poetry run mypy src/omnibase_core/ && poetry run pytest tests/unit/ -x`
5. [ ] Continue with incomplete tasks from Section 5
